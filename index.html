<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>CodeClock</title>
    <style>
        :root {
            --green: #44ff44;
            --red: #ff4444;
            --red-light: #ff6b6b;
            --orange: #ffa500;
            --teal: #4ecdc4;
            --bg-dark: #1a1a2e;
            --bg-card: #2a2a4e;
            --bg-secondary: #2a2a4e;
            --bg-tertiary: #3a3a5e;
            --bg-input: rgba(255,255,255,0.05);
            --text-primary: #ffffff;
            --text-secondary: #eeeeee;
            --text-muted: #888888;
            --text-dim: #666666;
            --border-color: #444444;
            --separator: rgba(255,255,255,0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: #eee;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .header {
            background: var(--bg-card);
            padding: 14px 19px;
            padding-top: calc(14px + env(safe-area-inset-top));
            padding-bottom: 0px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            transition: padding 0.2s ease;
        }
        
        .header.expanded {
            padding: 24px 24px;
            padding-top: calc(24px + env(safe-area-inset-top));
            padding-bottom: 0px;
        }
        
        .header-left {
            cursor: pointer;
        }
        
        .header-left-label {
            font-size: 0.84rem;
            color: #888;
            text-transform: uppercase;
            transition: font-size 0.2s ease;
        }
        
        .header.expanded .header-left-label {
            font-size: 1.1rem;
        }
        
        .header-time {
            font-size: 2.16rem;
            font-weight: bold;
            font-family: monospace;
            transition: font-size 0.2s ease;
        }
        
        .header.expanded .header-time {
            font-size: 3.5rem;
        }
        
        .header-tap-hint {
            font-size: 0.75rem;
            color: #666;
            margin-top: -6px;
            transition: font-size 0.2s ease;
        }
        
        .header.expanded .header-tap-hint {
            font-size: 0.95rem;
            margin-top: -4px;
        }
        
        .header-tap-hint.hidden {
            display: none;
        }
        
        .header-alert {
            display: none;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--red);
            color: #fff;
            text-align: center;
            padding: 14px 19px;
            padding-top: calc(14px + env(safe-area-inset-top));
            font-size: 1.1rem;
            font-weight: bold;
            animation: alertFlash 0.5s infinite;
            z-index: 10;
            align-items: center;
            justify-content: center;
        }
        
        .header-alert.show {
            display: flex;
        }
        
        @keyframes alertFlash {
            0%, 100% { background: var(--red); }
            50% { background: #cc0000; }
        }
        
        .header-title {
            font-size: 1.32rem;
            font-weight: bold;
            color: #4ecdc4;
            transition: font-size 0.2s ease;
        }
        
        .header.expanded .header-title {
            font-size: 1.8rem;
        }
        
        .tabs {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border-bottom: 1px solid #333;
            transition: padding 0.2s ease;
        }
        
        .tabs.expanded {
            padding: 0;
        }
        
        .tab-row {
            display: flex;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px 4px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-muted);
            font-size: 0.72rem;
            cursor: pointer;
            white-space: nowrap;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            transition: all 0.2s ease;
        }
        
        .tabs.expanded .tab-btn {
            padding: 14px 8px;
            font-size: 1rem;
            gap: 6px;
        }
        
        .tab-btn.active {
            background: var(--bg-card);
            border-bottom-color: var(--green);
            color: #fff;
        }
        
        .tab-icon {
            font-size: 0.9em;
            margin-right: 2px;
            opacity: 0.8;
        }
        
        .tab-btn.active .tab-icon {
            opacity: 1;
        }
        
        .tab-icon-img {
            width: 18px;
            height: 18px;
            filter: invert(1);
            opacity: 0.7;
            transition: all 0.2s ease;
        }
        
        .tabs.expanded .tab-icon-img {
            width: 28px;
            height: 28px;
        }
        
        .tab-icon-img.icon-large {
            width: 48px;
            height: 48px;
        }
        
        .tab-icon-img.icon-medium {
            width: 18px;
            height: 18px;
        }
        
        .tab-btn.active .tab-icon-img {
            opacity: 1;
        }
        
        .tab-more-container {
            position: relative;
            flex: 1;
        }
        
        .tab-more-btn {
            width: 100%;
        }
        
        .more-dots {
            font-size: 0.6rem;
            letter-spacing: 1px;
            display: block;
        }
        
        .tab-more-menu {
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 150px;
            background: var(--bg-card);
            border: 1px solid #444;
            border-radius: 8px;
            margin-top: 4px;
            z-index: 100;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        .tab-more-menu.hidden {
            display: none;
        }
        
        .tab-more-item {
            display: block;
            width: 100%;
            padding: 14px 16px;
            background: transparent;
            border: none;
            border-bottom: 1px solid #333;
            color: #fff;
            font-size: 1rem;
            text-align: left;
            cursor: pointer;
        }
        
        .tab-more-item:last-child {
            border-bottom: none;
        }
        
        .tab-more-item:active {
            background: var(--bg-tertiary);
        }
        
        .tab-content {
            flex: 1;
            overflow: auto;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .timer-page {
            padding: 16px;
        }
        
        .start-controls {
            margin-bottom: 16px;
        }
        
        .start-controls.hidden {
            display: none;
        }
        
        .start-time-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 1.5rem;
        }
        
        .start-time-display span {
            color: #888;
        }
        
        .time-picker {
            padding: 12px 16px;
            font-size: 1.5rem;
            text-align: center;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: #fff;
            min-width: 140px;
        }
        
        .time-picker::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        
        .start-time-input {
            width: 70px;
            padding: 12px 8px;
            font-size: 1.5rem;
            text-align: center;
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 8px;
            color: #fff;
            -moz-appearance: textfield;
        }
        
        .start-time-input::-webkit-outer-spin-button,
        .start-time-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .timer-box {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            border: 3px solid #666;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .rhythm-check-box {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 3px solid #666;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .rhythm-check-box.expired {
            background: rgba(255,68,68,0.2);
            animation: pulse 0.5s infinite;
            border-color: var(--red);
        }
        
        .rhythm-buttons {
            display: flex;
            flex-wrap: nowrap;
            gap: 12px;
            margin-top: 16px;
        }
        
        .rhythm-btn {
            flex: 1;
            min-width: 0;
            padding: 14px 8px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .rhythm-btn.vf {
            background: #666;
            color: #fff;
        }
        
        .rhythm-btn.pea {
            background: #666;
            color: #fff;
        }
        
        /* Initial state - rhythm buttons dominate screen */
        .timer-page.initial-state .rhythm-check-box {
            min-height: 50vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .timer-page.initial-state .rhythm-buttons {
            flex-direction: column;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 32px;
        }
        
        .timer-page.initial-state .rhythm-btn {
            padding: 40px 20px;
            font-size: 1.8rem;
        }
        
        .timer-page.initial-state .timer-box-label {
            font-size: 1.5rem;
        }
        
        .timer-box.expired {
            background: rgba(255,68,68,0.2);
            animation: pulse 0.5s infinite;
        }
        
        .timer-box-label {
            font-size: 1.035rem;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .timer-box-time {
            font-size: 4.6rem;
            font-weight: bold;
            font-family: monospace;
            color: #666;
        }
        
        .timer-box-time.hidden {
            display: none;
        }
        
        .timer-box-hint {
            font-size: 1.035rem;
            color: #ff4444;
            margin-top: 8px;
            font-weight: bold;
        }
        
        .timer-box-note {
            font-size: 0.86rem;
            color: #888;
            margin-top: 4px;
        }
        
        .timer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 20px;
        }
        
        .timer-grid.hidden {
            display: none;
        }
        
        .small-timer {
            padding: 12px;
            display: flex;
            flex-direction: column;
            min-height: 110px;
        }
        
        .small-timer .timer-box-label {
            font-size: 0.92rem;
        }
        
        .small-timer .timer-box-time {
            font-size: 1.9rem;
        }
        
        .small-timer .timer-box-note {
            margin-top: auto;
        }
        
        .shock-counter {
            background: rgba(255,255,255,0.05);
            border: 3px solid #666;
            border-radius: 16px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            flex-direction: column;
            min-height: 110px;
        }
        
        .shock-counter .shock-hint {
            margin-top: auto;
        }
        
        .shock-counter.hidden {
            display: none;
        }
        
        .shock-label {
            font-size: 0.92rem;
            color: #aaa;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .shock-count {
            font-size: 2.3rem;
            font-weight: bold;
            color: #666;
        }
        
        .shock-hint {
            font-size: 0.86rem;
            color: #888;
            margin-top: 4px;
        }
        
        .btn-rosc {
            width: 100%;
            padding: 12px;
            margin-top: 64px;
            font-size: 0.9rem;
            background: transparent;
            color: #888;
            border: 1px solid #444;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .btn-rosc.rearrest {
            background: transparent;
            color: #ff6b6b;
            border-color: #ff6b6b;
        }
        
        .btn-rosc.hidden {
            display: none;
        }
        
        .btn-rosc-history {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            font-size: 0.9rem;
            background: transparent;
            color: #4ecdc4;
            border: 1px solid #4ecdc4;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .btn-rosc-history.hidden {
            display: none;
        }
        
        .btn-terminate {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            font-size: 0.9rem;
            background: transparent;
            color: #888;
            border: 1px solid #444;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .btn-terminate.hidden {
            display: none;
        }
        
        .rosc-history-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .rosc-history-item .duration {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        .rosc-history-item .times {
            font-size: 0.9rem;
            color: #888;
            margin-top: 4px;
        }
        
        .btn-update-time {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            font-size: 0.9rem;
            background: transparent;
            color: #888;
            border: 1px solid #444;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .btn-update-time.hidden {
            display: none;
        }
        
        .header-rosc {
            font-size: 0.8rem;
            color: #44ff44;
            margin-top: 4px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.hidden {
            display: none;
        }
        
        .modal {
            background: #2a2a4e;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .modal h2 {
            margin-bottom: 16px;
            font-size: 1.3rem;
        }
        
        .modal p {
            margin-bottom: 12px;
            color: #aaa;
        }
        
        .btn-modal {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .btn-modal:last-child {
            margin-bottom: 0;
        }
        
        .btn-green { background: #44ff44; color: #000; font-weight: bold; }
        .btn-teal { background: #4ecdc4; color: #000; font-weight: bold; }
        .btn-orange { background: #ffa500; color: #000; }
        .btn-gray { background: #666; color: #fff; }
        
        .amio-alert {
            margin-bottom: 16px;
            text-align: center;
        }
        
        .amio-alert p {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--orange);
        }
        
        .amio-alert .sub {
            font-size: 1rem;
            color: #aaa;
            margin-top: 8px;
            font-weight: normal;
        }
        
        .ht-page {
            padding: 16px;
        }
        
        .ht-page h3 {
            margin-bottom: 12px;
            font-size: 1.1rem;
            color: #4ecdc4;
        }
        
        .ht-page h4 {
            margin-top: 24px;
            margin-bottom: 12px;
            font-size: 1rem;
            color: #888;
        }
        
        .check-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .check-item.checked {
            background: rgba(68,255,68,0.1);
            border-color: #44ff44;
        }
        
        .check-box {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid #666;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }
        
        .check-item.checked .check-box {
            background: #44ff44;
            border-color: #44ff44;
            color: #000;
            font-weight: bold;
        }
        
        .check-label {
            font-weight: 500;
            font-size: 1rem;
        }
        
        .check-arrow {
            color: #ffa500;
            margin-left: 8px;
            font-size: 0.9rem;
        }
        
        .drugs-page {
            padding: 16px;
        }
        
        .drugs-page h3 {
            margin-bottom: 16px;
        }
        
        .drug-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            margin-bottom: 8px;
            align-items: flex-start;
        }
        
        .drug-item:not(:last-child) {
            border-bottom: none;
        }
        
        .drug-left {
            flex: 1;
        }
        
        .drug-name {
            color: #4ecdc4;
            font-weight: 500;
        }
        
        .drug-dose {
            font-family: monospace;
            color: #fff;
            text-align: right;
            font-size: 0.9rem;
        }
        
        .drug-indication {
            font-size: 0.8rem;
            color: #888;
            margin-top: 4px;
        }
        
        .drug-section-toggle {
            width: 100%;
            padding: 14px;
            margin-top: 12px;
            background: #3a3a5e;
            color: #aaa;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            text-align: left;
        }
        
        .drug-section-toggle:first-of-type {
            margin-top: 16px;
        }
        
        .drug-section {
            margin-top: 8px;
            display: none;
            padding-left: 8px;
            border-left: 3px solid #3a3a5e;
        }
        
        .drug-section.show {
            display: block;
        }
        
        .core-drugs {
            margin-bottom: 8px;
        }
        
        .core-drugs .drug-item {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        .stop-page {
            padding: 20px;
        }
        
        .stop-page h3 {
            margin-bottom: 16px;
            font-size: 1.3rem;
        }
        
        .poor-prog {
            background: rgba(255,107,107,0.1);
            border: 2px solid #ff6b6b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .poor-prog h4 {
            margin-bottom: 12px;
            color: #ff6b6b;
            font-size: 1.1rem;
        }
        
        .poor-prog ul {
            padding-left: 20px;
            line-height: 2;
            font-size: 1.05rem;
        }
        
        .prognosis-calc {
            background: #2a2a4e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .prognosis-calc h4 {
            margin-bottom: 6px;
            font-size: 1.4rem;
        }
        
        .calc-subtitle {
            font-size: 1.05rem;
            color: #888;
            margin-bottom: 20px;
            margin-top: 0;
        }
        
        .calc-row {
            margin-bottom: 20px;
        }
        
        .calc-row label {
            display: block;
            margin-bottom: 12px;
            color: #ccc;
            font-size: 1.15rem;
        }
        
        .calc-btns {
            display: flex;
            gap: 10px;
        }
        
        .calc-btn {
            flex: 1;
            padding: 16px;
            background: #1a1a2e;
            color: #888;
            border: 2px solid #444;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.15s;
        }
        
        .calc-btn.active {
            background: rgba(68, 255, 68, 0.1);
            color: #44ff44;
            border-color: #44ff44;
            font-weight: bold;
        }
        
        .arrest-time-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .arrest-time-input select {
            width: 90px;
            padding: 12px;
            font-size: 1.2rem;
            text-align: center;
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 8px;
            color: #fff;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .arrest-time-input span {
            color: var(--text-muted);
            font-size: 1rem;
        }
        
        .auto-sync-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            margin-left: 8px;
        }
        
        .auto-sync-toggle input {
            width: 18px;
            height: 18px;
            accent-color: var(--green);
        }
        
        .auto-sync-toggle .toggle-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .auto-sync-toggle input:checked + .toggle-label {
            color: var(--green);
        }
        
        .prognosis-results {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .prognosis-box {
            flex: 1;
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        
        .prognosis-box.primary {
            border: 2px solid #4a4a6e;
        }
        
        .prognosis-box .prog-label {
            color: #aaa;
            font-size: 1.05rem;
            margin-bottom: 8px;
        }
        
        .prognosis-box .prog-value {
            font-size: 2.6rem;
            font-weight: bold;
            color: #888;
        }
        
        .prognosis-box .prog-value.good { color: #44ff44; }
        .prognosis-box .prog-value.medium { color: #ffa500; }
        .prognosis-box .prog-value.bad { color: #ff6b6b; }
        
        .stop-footer {
            color: #888;
            font-size: 1rem;
            font-style: italic;
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .stop-footer p {
            margin: 6px 0;
        }
        
        .prognosis-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .prognosis-toggle-btn {
            flex: 1;
            padding: 16px 16px;
            background: transparent;
            color: #fff;
            border: 2px solid #444;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.15rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .prognosis-toggle-btn:hover {
            border-color: #666;
            color: #fff;
        }
        
        .prognosis-toggle-btn.active {
            background: rgba(78, 205, 196, 0.15);
            border-color: #4ecdc4;
            color: #4ecdc4;
        }
        
        .prognosis-prompt {
            text-align: center;
            padding: 8px 20px 12px;
            color: #fff;
            font-size: 1.1rem;
        }
        
        .prognosis-prompt.hidden {
            display: none;
        }
        
        .prognosis-section {
            display: none;
        }
        
        .prognosis-section.active {
            display: block;
        }
        
        .oohca-result {
            padding: 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-top: 16px;
            text-align: center;
        }
        
        .oohca-placeholder {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            padding: 20px 0;
        }
        
        .oohca-output.hidden {
            display: none;
        }
        
        .oohca-duration-row {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .oohca-probability {
            font-size: 3rem;
            font-weight: bold;
            color: #fff;
        }
        
        .oohca-probability.good {
            color: #44ff44;
        }
        
        .oohca-probability.medium {
            color: #ffa500;
        }
        
        .oohca-probability.bad {
            color: #ff6b6b;
        }
        
        .oohca-outcome-label {
            font-size: 1.1rem;
            color: #fff;
            margin-top: 12px;
            line-height: 1.5;
        }
        
        .oohca-caveats {
            margin-top: 20px;
            padding: 14px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 1rem;
            color: #888;
            line-height: 1.6;
        }
        
        .oohca-caveats p {
            margin: 8px 0;
        }
        
        /* IO Page */
        .io-page {
            padding: 16px;
        }
        
        .io-page h3 {
            margin-bottom: 16px;
        }
        
        .io-section {
            margin-bottom: 20px;
        }
        
        .io-section h4 {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .io-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: #1a1a2e;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .io-needle {
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 4px;
            min-width: 60px;
            text-align: center;
        }
        
        .io-item.pink .io-needle { background: #ff69b4; color: #000; }
        .io-item.blue .io-needle { background: #4a9eff; color: #000; }
        .io-item.yellow .io-needle { background: #ffd700; color: #000; }
        
        .io-detail {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .io-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .io-list span {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .io-list.good span {
            background: rgba(68, 255, 68, 0.15);
            color: #44ff44;
            border: 1px solid rgba(68, 255, 68, 0.3);
        }
        
        .io-list.bad span {
            background: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        .ecpr-page {
            padding: 20px;
        }
        
        .ecpr-page h3 {
            margin-bottom: 8px;
            font-size: 1.5rem;
        }
        
        .ecpr-page .subtitle {
            color: #888;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .ecpr-form {
            background: #2a2a4e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .ecpr-form label {
            display: block;
            margin-bottom: 12px;
            color: #ccc;
            font-size: 1.15rem;
            line-height: 1.4;
        }
        
        .ecpr-form input {
            width: 100%;
            padding: 14px;
            font-size: 1.2rem;
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 8px;
            color: #fff;
            margin-bottom: 10px;
        }
        
        .ecpr-age-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .ecpr-age-input select {
            width: 110px;
            padding: 14px 10px;
            font-size: 1.6rem;
            text-align: center;
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 8px;
            color: #fff;
            -webkit-appearance: none;
            appearance: none;
            text-align-last: center;
        }
        
        .ecpr-age-input span {
            font-size: 1.3rem;
            color: #888;
        }
        
        .ecpr-form .age-warning {
            margin-top: 8px;
            color: #ff6b6b;
            font-size: 0.9rem;
        }
        
        .ecpr-factors {
            margin-top: 24px;
            padding: 16px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 8px;
        }
        
        .ecpr-factors h4 {
            color: #4CAF50;
            margin: 0 0 10px 0;
            font-size: 1.2rem;
        }
        
        .ecpr-factors ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .ecpr-factors li {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #ccc;
            line-height: 1.5;
        }
        
        .ecpr-note {
            margin-top: 10px;
            font-size: 0.95rem;
            color: #888;
            font-style: italic;
        }
        
        .ecpr-row {
            margin-bottom: 16px;
        }
        
        .ecpr-btns {
            display: flex;
            gap: 10px;
        }
        
        .ecpr-btn {
            flex: 1;
            padding: 16px;
            background: #1a1a2e;
            color: #888;
            border: 2px solid #444;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 1.15rem;
        }
        
        .ecpr-btn.yes { 
            background: rgba(68, 255, 68, 0.1); 
            color: #44ff44; 
            border-color: #44ff44;
            font-weight: bold;
        }
        .ecpr-btn.no { 
            background: rgba(255, 107, 107, 0.1); 
            color: #ff6b6b; 
            border-color: #ff6b6b;
            font-weight: bold;
        }
        
        .ecpr-survival {
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }
        
        .ecpr-survival.show {
            display: block;
        }
        
        .ecpr-survival.good { background: rgba(68,255,68,0.1); border: 2px solid #44ff44; }
        .ecpr-survival.medium { background: rgba(255,165,0,0.1); border: 2px solid #ffa500; }
        .ecpr-survival.bad { background: rgba(255,68,68,0.1); border: 2px solid #ff6b6b; }
        .ecpr-survival.neutral { background: rgba(255,255,255,0.05); border: 2px solid #666; }
        
        .ecpr-survival .label {
            color: #aaa;
            margin-bottom: 10px;
            font-size: 1.15rem;
        }
        
        .ecpr-survival .value {
            font-size: 2.8rem;
            font-weight: bold;
        }
        
        .ecpr-survival.good .value { color: #44ff44; }
        .ecpr-survival.medium .value { color: #ffa500; }
        .ecpr-survival.bad .value { color: #ff6b6b; }
        .ecpr-survival.neutral .value { color: #888; font-size: 1.15rem; }
        
        .ecpr-stop {
            margin-top: 16px;
            background: rgba(255,107,107,0.1);
            border-radius: 8px;
            padding: 12px;
        }
        
        .ecpr-stop h4 {
            color: #ff6b6b;
            margin: 0 0 8px 0;
            font-size: 0.95rem;
        }
        
        .ecpr-stop ul {
            margin: 0;
            padding-left: 20px;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        .ecpr-stop li {
            color: #ccc;
            margin-bottom: 4px;
        }
        
        .ecpr-stop .exception {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
        }
        
        /* Sequential Wizard UI */
        .wizard {
            padding: 20px;
            min-height: 70vh;
            display: flex;
            flex-direction: column;
        }
        
        .wizard-progress {
            display: flex;
            gap: 6px;
            margin-bottom: 24px;
        }
        
        .wizard-progress-dot {
            flex: 1;
            height: 4px;
            background: #444;
            border-radius: 2px;
            transition: background 0.3s ease;
        }
        
        .wizard-progress-dot.complete {
            background: #4ecdc4;
        }
        
        .wizard-progress-dot.current {
            background: #4ecdc4;
        }
        
        .wizard-step {
            display: none;
            flex: 1;
            flex-direction: column;
        }
        
        .wizard-step.active {
            display: flex;
        }
        
        .wizard-question {
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .wizard-subtitle {
            font-size: 1.1rem;
            color: #888;
            margin-bottom: 32px;
        }
        
        .wizard-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }
        
        .wizard-option {
            padding: 20px 24px;
            background: rgba(255,255,255,0.05);
            border: 2px solid #444;
            border-radius: 12px;
            color: #fff;
            font-size: 1.25rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .wizard-option:active {
            transform: scale(0.98);
        }
        
        .wizard-option.selected {
            background: rgba(78, 205, 196, 0.15);
            border-color: #4ecdc4;
            color: #4ecdc4;
        }
        
        .wizard-option-hint {
            font-size: 0.95rem;
            color: #888;
            margin-top: 4px;
        }
        
        .wizard-option.selected .wizard-option-hint {
            color: #4ecdc4;
            opacity: 0.8;
        }
        
        .wizard-number-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin: 20px 0;
        }
        
        .wizard-number-input select {
            width: 140px;
            padding: 18px 16px;
            font-size: 2rem;
            text-align: center;
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 12px;
            color: #fff;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .wizard-number-input span {
            font-size: 1.3rem;
            color: #888;
        }
        
        .wizard-next {
            margin-top: auto;
            padding: 18px;
            background: #4ecdc4;
            color: #1a1a2e;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }
        
        .wizard-next:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }
        
        .wizard-back {
            padding: 14px;
            background: transparent;
            color: #888;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .wizard-result {
            text-align: center;
            padding: 24px;
        }
        
        .wizard-result-value {
            font-size: 4rem;
            font-weight: bold;
            margin: 16px 0;
        }
        
        .wizard-result-value.good { color: #44ff44; }
        .wizard-result-value.medium { color: #ffa500; }
        .wizard-result-value.bad { color: #ff6b6b; }
        
        .wizard-result-label {
            font-size: 1.2rem;
            color: #aaa;
            line-height: 1.5;
        }
        
        .wizard-result-details {
            margin-top: 24px;
            padding: 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            text-align: left;
        }
        
        .wizard-result-details p {
            margin: 8px 0;
            color: #aaa;
            font-size: 1rem;
        }
        
        .wizard-reset {
            margin-top: 24px;
            padding: 14px 24px;
            background: transparent;
            color: #4ecdc4;
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .wizard-footer {
            margin-top: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            font-size: 0.95rem;
            color: #666;
            line-height: 1.5;
        }
        
        .log-page {
            padding: 20px;
        }
        
        .log-summary {
            background: rgba(100, 210, 255, 0.08);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
            font-size: 0.85rem;
        }
        
        .log-summary h4 {
            color: var(--teal);
            margin: 0 0 12px 0;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .log-summary-content {
            line-height: 1.6;
            white-space: pre-wrap;
            font-family: inherit;
            color: var(--text-secondary);
        }
        
        .log-summary .btn-copy-summary {
            margin-top: 12px;
            padding: 10px 16px;
            background: var(--teal);
            color: #000;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .btn-copy {
            padding: 10px 16px;
            background: var(--teal);
            color: #000;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .log-entries {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 16px;
            font-variant-numeric: tabular-nums;
            font-size: 0.8rem;
            max-height: 60vh;
            overflow: auto;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--separator);
        }
        
        .log-entry .time {
            color: var(--teal);
        }
        
        .log-entry .sep {
            color: var(--text-muted);
        }
        
        .log-empty {
            color: var(--text-dim);
        }
        
        .info-page {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .info-page h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .info-page h4 {
            color: var(--teal);
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-page p {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .info-page strong {
            color: var(--text-primary);
        }
        
        .info-version {
            color: var(--text-dim);
            font-size: 0.8rem;
        }
        
        .info-warning {
            background: rgba(255, 69, 58, 0.12);
            border-radius: var(--radius-md);
            padding: 14px;
            margin: 16px 0;
            font-size: 0.85rem;
            color: var(--red-light);
            line-height: 1.5;
        }
        
        .info-warning strong {
            color: var(--red);
        }
        
        .info-box {
            background: rgba(100, 210, 255, 0.08);
            border-radius: var(--radius-md);
            padding: 14px;
            margin: 12px 0;
        }
        
        .info-box p {
            margin-bottom: 8px;
        }
        
        .info-box p:last-child {
            margin-bottom: 0;
        }
        
        .info-accept {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 24px;
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.8;
        }
        
        .info-accept strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 8px;
        }
        
        .copyright {
            text-align: center;
            color: var(--text-dim);
            font-size: 0.7rem;
            margin-top: 40px;
            padding-bottom: 20px;
        }
        
        /* Landing Screen */
        #landingScreen {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            background: var(--bg-dark);
        }
        
        #landingScreen.hidden {
            display: none;
        }
        
        .landing-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 60px;
            text-align: center;
        }
        
        .landing-btn {
            width: 100%;
            max-width: 320px;
            padding: 32px 24px;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .landing-btn-new {
            background: var(--green);
            color: #000;
        }
        
        .landing-btn-progress {
            background: var(--orange);
            color: #000;
        }
        
        .landing-copyright {
            position: absolute;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.75rem;
            color: #666;
        }
        
        /* Setup Modal */
        .setup-modal {
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .setup-section {
            margin-bottom: 24px;
        }
        
        .setup-section:last-of-type {
            margin-bottom: 32px;
        }
        
        .setup-section.hidden {
            display: none;
        }
        
        .setup-label {
            font-size: 1rem;
            color: #888;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .setup-btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .setup-btn {
            flex: 1;
            min-width: 60px;
            padding: 14px 12px;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid #444;
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: #fff;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .setup-btn:active {
            transform: scale(0.97);
        }
        
        .setup-btn.selected {
            border-color: var(--green);
            background: rgba(68, 255, 68, 0.15);
            color: var(--green);
        }
        
        .setup-btn-wide {
            flex: 0 0 100%;
        }
        
        .setup-sub-options {
            display: none;
            margin-top: 12px;
        }
        
        .setup-sub-options.visible {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .time-wheel-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            width: 100%;
        }
        
        .time-wheel {
            flex: 1;
            max-width: 100px;
            padding: 14px 8px;
            font-size: 1.4rem;
            font-weight: 600;
            text-align: center;
            background: var(--bg-tertiary);
            color: #fff;
            border: 2px solid #444;
            border-radius: 10px;
            appearance: none;
            -webkit-appearance: none;
        }
        
        .time-wheel-sep {
            font-size: 1.6rem;
            font-weight: bold;
            color: #888;
        }
        
        #btnStartSetup {
            width: 100%;
            padding: 18px;
            font-size: 1.3rem;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            background: #444;
            color: #666;
            cursor: not-allowed;
            transition: all 0.2s;
        }
        
        #btnStartSetup.ready {
            background: var(--green);
            color: #000;
            cursor: pointer;
        }
        
        .setup-validation {
            color: var(--red);
            font-size: 0.9rem;
            margin-bottom: 16px;
            min-height: 1.2em;
        }
    </style>
</head>
<body>
    <!-- Landing Screen -->
    <div id="landingScreen">
        <div class="landing-title">CodeClock</div>
        <button class="landing-btn landing-btn-new" id="btnNewCode">New Arrest</button>
        <button class="landing-btn landing-btn-progress" id="btnCodeInProgress">Resus in Progress</button>
        <div class="landing-copyright"> Scott Santinon</div>
    </div>
    
    <!-- Setup Modal for Code in Progress -->
    <div class="modal-overlay hidden" id="setupModal">
        <div class="modal setup-modal">
            <h2>Resus in Progress</h2>
            
            <div class="setup-section">
                <div class="setup-label">Time since collapse</div>
                <div class="setup-btn-group" id="setupTimeGroup">
                    <button class="setup-btn" data-mins="3">~3 min</button>
                    <button class="setup-btn" data-mins="5">~5 min</button>
                    <button class="setup-btn" data-mins="custom">Enter time</button>
                </div>
                <div class="setup-sub-options" id="customTimeSection">
                    <div class="time-wheel-container">
                        <select class="time-wheel" id="setupHours"></select>
                        <span class="time-wheel-sep">:</span>
                        <select class="time-wheel" id="setupMinutes"></select>
                    </div>
                </div>
            </div>
            
            <div class="setup-section">
                <div class="setup-label">Shocks Given</div>
                <div class="setup-btn-group" id="setupShocksGroup">
                    <button class="setup-btn" data-shocks="0">0</button>
                    <button class="setup-btn" data-shocks="1">1</button>
                    <button class="setup-btn" data-shocks="2">2</button>
                    <button class="setup-btn" data-shocks="3+">3+</button>
                </div>
                <div class="setup-sub-options" id="shocksExactSection">
                    <button class="setup-btn" data-shocks-exact="3">3</button>
                    <button class="setup-btn" data-shocks-exact="4">4</button>
                    <button class="setup-btn" data-shocks-exact="5">5</button>
                    <button class="setup-btn" data-shocks-exact="6">6+</button>
                </div>
            </div>
            
            <div class="setup-section hidden" id="setupRhythmSection">
                <div class="setup-label">Initial Rhythm</div>
                <div class="setup-btn-group" id="setupRhythmGroup">
                    <button class="setup-btn" data-rhythm="nonshockable">Non-shockable</button>
                    <button class="setup-btn" data-rhythm="notchecked">Not yet checked</button>
                </div>
            </div>
            
            <div class="setup-section hidden" id="setupAmioSection">
                <div class="setup-label">Amiodarone Given?</div>
                <div class="setup-btn-group" id="setupAmioGroup">
                    <button class="setup-btn" data-amio="yes">Yes</button>
                    <button class="setup-btn" data-amio="no">No</button>
                </div>
            </div>
            
            <div class="setup-section">
                <div class="setup-label">Adrenaline</div>
                <div class="setup-btn-group" id="setupAdrenalineGroup">
                    <button class="setup-btn" data-adr="none">None yet</button>
                    <button class="setup-btn" data-adr="given">Just given</button>
                    <button class="setup-btn" data-adr="due">Due soon</button>
                </div>
            </div>
            
            <div class="setup-validation" id="setupValidation"></div>
            <button id="btnStartSetup">START</button>
            <button class="btn-modal btn-gray" id="btnCancelSetup" style="margin-top: 12px;">Cancel</button>
        </div>
    </div>
    
    <div id="app" class="hidden">
        <div class="header">
            <div class="header-left" id="headerLeft">
                <div class="header-left-label">Time since arrest</div>
                <div class="header-time" id="totalTime">0:00</div>
                <div class="header-tap-hint hidden" id="headerTapHint">tap to update</div>
                <div class="header-rosc" id="roscDisplay"></div>
            </div>
            <div style="text-align: right;">
                <div class="header-title">CodeClock</div>
            </div>
            <div class="header-alert" id="headerAlert"></div>
        </div>
        
        <div class="tabs">
            <div class="tab-row">
                <button class="tab-btn active" data-tab="timer"><img class="tab-icon-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAACYktHRAD/h4/MvwAAAAlwSFlzAAAOwwAADsMBx2+oZAAAAAd0SU1FB+kMCgQ0D3tOqzUAAAL2SURBVEjHjdVPaFxVFMfxz0zMmEkm0+bPaNrRJGqpG3WKGwcCNhKkEWsD3RSR0ESo0NSN4KagUDdKUIq4cGOyEkTcuBTaRQtKDaRJamgRXGiTMK3atLGJmpqZyXWRaZwkM4nnbR73nPu995x3fudRzbrMCKVnRle1sGhVQFb7+nu7bLWwB6oCLrokLSAi52K1sIjqnrS0uGBZzg2htB6XV9geEPGwLgc9rU0D/nTTtAsumdfiI7M+tlD1YG3e9oO8oGBBTs6ComDFuCEfKlr1mVjlGkT1eE9W0bRzvjdjUZDUKeuQAz4RRBXNlidRXtATfhNMGdBaSq7eXklRtBgwJQi+01q5aCcsyhvVjphuSZx03aQvvG4P2o3Ku+VYJcAhvysYlhATEzcohTOlViq44rg6DYYVzG5trL3GBCMS6HN0ff3MejcGy85KajAiOK9lI+C0YFIHaCnLsRwQFJ0V02FScLJ8+yOuKRpAj94N4I2AYNlxDFo1Vn6H1wSXpbDP/m0BwZQ9Wk1Y8fLalyfiBZx3S6M5P9nentFr3jm1Dt4HNHpKMIZ+B+xkUS9iTJBRt9aJu7W56zq+dG9HAE9K+sWitIR7UdRr8LclEcE/m4JDBcBuCYv+khAv10KwyymfurMh+Jsteo24aUFb+VK7GQsyaFazYwJ1mpDxh2tSa0W861e7dKKgeUdAxqvolJSztAZYdFVEFs86vCPgis+RFTH9X8n7S41UK77D9v32IWVC3ivlVfhR0SAedLSy2kvWqweDisalyh3vlsRUq2+zztatteTpNCl4c6PzUZfX5UzvJkWs2VF9SBgRXNh6z8PmSwOFHk+o9Zx6Uc2iUgbFxdRKGFaQ8/xWftQpS/JGS1Oh0ZBmTd7RrFG3mPsj7Y7+yjnWGjK/aajWaFKDiNbSUL2hv3q71XjJuFV5Ez5wRMbjHpNxxPsm5K36Vvc2fzOQdtpVeUHebXPm3JYXrJjylof8D4vo8IavzcgLghU/+8qAdKWz/wV6KQF9aoLz7QAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAASUVORK5CYII=" alt="">Timer</button>
                <button class="tab-btn" data-tab="hts"><img class="tab-icon-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAAAAABWESUoAAAAAmJLR0QA/4ePzL8AAAAHdElNRQfpDAoEGDj6wmWUAAAB/0lEQVQ4y21TPWhTURT+zrnvmVgR9IW02EWHOKjQQkVQoo1QtwxOQsHBnxYXS+mQqrNSRIJCFXWSDoUuLg6KxqXdHKQ0tM3QOpRQKKbQR9BEaN979zg0eXm5yTccznvn+875DvdecgEo2fdhgGJ2IAAsALLyda1u1EX1Z0YSGoDr/n7ai26wMktVd49ceffsIDmUMCd4myVv4MNZTdWV0cqlmUHb1Et1Pl8fe8GMQiU5c7mjDnImRlEoM++vYmjQ72JB7Gxsd4vZryMR1QsAVgAgTtyrwYIYrQEsetft5m9u6KQhhgiXpu49/xcuC2rqGoFqr8r46fVIW4coFj4jMX3CGNECF9949OCaDr9bJpkB0J+X2xgeo5Yg3I7XfgDAwjf0Pk7qCOGQTLw8fvcLqeXXvnp4JWh1sMLs+wZyMpzfwY07kM4RkFtpVJ5MLaJ/+mSk3jIpqdk0dj4dWJMXg7atwkynZtMAsreNtUFtjDO54+2HY0XyIPX248AFDURNRgmkTz8SHZ5KkxDtKG3+Dj2QBV/QDeRrUuDYKWxWqSuh9PdYn7CdsdbnA8WKFTcDM7OyNuZwPqWtYOTqUn4765j6YH2uePS+o2lPFSdXEYubBF3X8YncESEX/Ot9Ybfz8facG78ZE5ALsF/eqgEkCAOJ6ks5GgC54WUyIFoA4D9ewblWA9FfBgAAAABJRU5ErkJggg==" alt="">Actions</button>
                <div class="tab-more-container">
                    <button class="tab-btn tab-more-btn" id="tabMoreBtn"><span class="more-dots"></span>More</button>
                    <div class="tab-more-menu hidden" id="tabMoreMenu">
                        <button class="tab-more-item" data-tab="ecpr">E-CPR Calculator</button>
                        <button class="tab-more-item" data-tab="stop">Prognosis</button>
                        <button class="tab-more-item" data-tab="drugs">Drugs</button>
                        <button class="tab-more-item" data-tab="io">IO Access</button>
                        <button class="tab-more-item" data-tab="log">Event Log</button>
                        <button class="tab-more-item" data-tab="info">Info</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content active" id="tab-timer">
            <div class="timer-page initial-state">
                <div class="rhythm-check-box" id="rhythmCheckBox">
                    <div class="timer-box-label" id="rhythmCheckLabel">Rhythm Check</div>
                    <div class="timer-box-time hidden" id="cprTime"></div>
                    <div class="timer-box-hint" id="cprHint"></div>
                    <div class="rhythm-buttons">
                        <button class="rhythm-btn vf" id="btnVfVt">VF / VT</button>
                        <button class="rhythm-btn pea" id="btnPea">PEA / Asystole</button>
                    </div>
                </div>
                <div class="timer-grid hidden" id="timerGrid">
                    <div class="timer-box small-timer" id="adrenalineTimer">
                        <div class="timer-box-label" id="adrenalineLabel">Adrenaline</div>
                        <div class="timer-box-time" id="adrenalineTime">TAP</div>
                        <div class="timer-box-hint" id="adrHint"></div>
                        <div class="timer-box-note" id="adrNote">Tap when given</div>
                    </div>
                    <div class="shock-counter hidden" id="shockCounter">
                        <div class="shock-label">Shocks</div>
                        <div class="shock-count" id="shockCount">TAP</div>
                        <div class="shock-hint" id="shockHint">Tap when given</div>
                    </div>
                </div>
                <button class="btn-rosc hidden" id="btnRosc">ROSC</button>
                <button class="btn-rosc-history hidden" id="btnRoscHistory">See times/durations of ROSC</button>
                <button class="btn-terminate hidden" id="btnTerminate">Termination of Resuscitation</button>
                <div class="copyright"> 2025 Scott Santinon</div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-hts">
            <div class="ht-page">
                <h3>Actions</h3>
                <div id="actionsList"></div>
                <div class="copyright"> 2025 Scott Santinon</div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-drugs">
            <div class="drugs-page">
                <h3>Drug Reference</h3>
                
                <div class="core-drugs" id="coreDrugsList"></div>
                
                <button class="drug-section-toggle" data-section="electrolyteSection"> Electrolyte Emergencies</button>
                <div class="drug-section" id="electrolyteSection"></div>
                
                <button class="drug-section-toggle" data-section="causesSection"> Suspected PE</button>
                <div class="drug-section" id="causesSection"></div>
                
                <button class="drug-section-toggle" data-section="toxidromeSection"> Toxidrome Antidotes</button>
                <div class="drug-section" id="toxidromeSection"></div>
                
                <div class="copyright"> 2025 Scott Santinon</div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-io">
            <div class="io-page">
                <h3>Intraosseous Access</h3>
                
                <div class="io-section">
                    <h4>Needle Size</h4>
                    <div class="io-item pink">
                        <div class="io-needle">Pink</div>
                        <div class="io-detail">15mm  Paediatric or &lt;40kg</div>
                    </div>
                    <div class="io-item blue">
                        <div class="io-needle">Blue</div>
                        <div class="io-detail">25mm  Standard adult</div>
                    </div>
                    <div class="io-item yellow">
                        <div class="io-needle">Yellow</div>
                        <div class="io-detail">45mm  Obese or humeral site</div>
                    </div>
                </div>
                
                <div class="io-section">
                    <h4>IO samples correlate well with venous</h4>
                    <div class="io-list good">
                        <span>Haemoglobin</span>
                        <span>Haematocrit</span>
                        <span>Chloride</span>
                        <span>Glucose</span>
                        <span>Urea</span>
                        <span>Creatinine</span>
                        <span>Albumin</span>
                    </div>
                </div>
                
                <div class="io-section">
                    <h4>IO samples correlate poorly with venous</h4>
                    <div class="io-list bad">
                        <span>WBC</span>
                        <span>Platelets</span>
                        <span>CO</span>
                        <span>Sodium</span>
                        <span>Potassium</span>
                        <span>Calcium</span>
                    </div>
                </div>
                <div class="copyright"> 2025 Scott Santinon</div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-stop">
            <div class="wizard" id="progWizard">
                <div class="wizard-progress" id="progProgress">
                    <div class="wizard-progress-dot current"></div>
                    <div class="wizard-progress-dot"></div>
                    <div class="wizard-progress-dot"></div>
                    <div class="wizard-progress-dot"></div>
                    <div class="wizard-progress-dot"></div>
                </div>
                
                <!-- Step 1: Arrest Type -->
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-question">Arrest location?</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-type="ihca">
                            In-Hospital (IHCA)
                        </button>
                        <button class="wizard-option" data-type="oohca">
                            Out-of-Hospital (OOHCA)
                        </button>
                    </div>
                </div>
                
                <!-- IHCA Step 2: Age -->
                <div class="wizard-step" data-step="ihca-2">
                    <div class="wizard-question">Patient age group?</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="age" data-value="<60">&lt;60 years</button>
                        <button class="wizard-option" data-field="age" data-value="60-79">6079 years</button>
                        <button class="wizard-option" data-field="age" data-value=">=80">80 years</button>
                    </div>
                    <button class="wizard-back" onclick="progBack('ihca-2')"> Back</button>
                </div>
                
                <!-- IHCA Step 3: Witnessed -->
                <div class="wizard-step" data-step="ihca-3">
                    <div class="wizard-question">Witnessed arrest?</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="witnessed" data-value="witnessed">Yes</button>
                        <button class="wizard-option" data-field="witnessed" data-value="unwitnessed">No</button>
                    </div>
                    <button class="wizard-back" onclick="progBack('ihca-3')"> Back</button>
                </div>
                
                <!-- IHCA Step 4: Rhythm -->
                <div class="wizard-step" data-step="ihca-4">
                    <div class="wizard-question">Initial rhythm?</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="rhythm" data-value="shockable">
                            Shockable
                            <div class="wizard-option-hint">VF / pulseless VT</div>
                        </button>
                        <button class="wizard-option" data-field="rhythm" data-value="nonshockable">
                            Non-shockable
                            <div class="wizard-option-hint">PEA / Asystole</div>
                        </button>
                    </div>
                    <button class="wizard-back" onclick="progBack('ihca-4')"> Back</button>
                </div>
                
                <!-- IHCA Step 5: Duration -->
                <div class="wizard-step" data-step="ihca-5">
                    <div class="wizard-question">CPR duration?</div>
                    <div class="wizard-subtitle">Minutes since arrest</div>
                    <div class="wizard-number-input">
                        <select id="ihcaMinsWizard"></select>
                        <span>minutes</span>
                    </div>
                    <label class="auto-sync-toggle" style="justify-content: center; margin-bottom: 20px;">
                        <input type="checkbox" id="ihcaAutoSyncWizard">
                        <span class="toggle-label">Use current resuscitation duration</span>
                    </label>
                    <button class="wizard-next" id="ihcaShowResult">Show Prognosis</button>
                    <button class="wizard-back" onclick="progBack('ihca-5')"> Back</button>
                </div>
                
                <!-- IHCA Result -->
                <div class="wizard-step" data-step="ihca-result">
                    <div class="wizard-result">
                        <div class="wizard-result-label">If no ROSC at this timepoint</div>
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="color: #aaa; font-size: 1.1rem; margin-bottom: 8px;">Survival</div>
                            <div class="wizard-result-value" id="ihcaSurvivalWizard" style="font-size: 3.5rem;"></div>
                        </div>
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="color: #aaa; font-size: 1.1rem; margin-bottom: 8px;">Survival with good neurological outcome</div>
                            <div class="wizard-result-value" id="ihcaNeuroWizard" style="font-size: 3.5rem;"></div>
                        </div>
                    </div>
                    <div class="wizard-footer">
                        <strong>Data source:</strong> Okubo et al. BMJ 2024<br>
                        US multicentre registry (GWTG-R) of 348,996 adult in-hospital cardiac arrests from 20002021.<br><br>
                        <strong>This is not a termination of resuscitation rule.</strong> Provided as an adjunct to clinical judgment only.
                    </div>
                    <button class="wizard-back" onclick="progBack('ihca-result')"> Back</button>
                    <button class="wizard-reset" onclick="progReset()">Start Over</button>
                </div>
                
                <!-- OOHCA Step 2: Rhythm -->
                <div class="wizard-step" data-step="oohca-2">
                    <div class="wizard-question">Initial rhythm?</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="oohcaRhythm" data-value="shockable">
                            Shockable
                            <div class="wizard-option-hint">VF / pulseless VT</div>
                        </button>
                        <button class="wizard-option" data-field="oohcaRhythm" data-value="nonshockable">
                            Non-shockable
                            <div class="wizard-option-hint">PEA / Asystole</div>
                        </button>
                    </div>
                    <button class="wizard-back" onclick="progBack('oohca-2')"> Back</button>
                </div>
                
                <!-- OOHCA Step 3: Witnessed -->
                <div class="wizard-step" data-step="oohca-3">
                    <div class="wizard-question">Witnessed arrest?</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="oohcaWitnessed" data-value="witnessed">Yes</button>
                        <button class="wizard-option" data-field="oohcaWitnessed" data-value="unwitnessed">No</button>
                    </div>
                    <button class="wizard-back" onclick="progBack('oohca-3')"> Back</button>
                </div>
                
                <!-- OOHCA Step 4: Bystander -->
                <div class="wizard-step" data-step="oohca-4">
                    <div class="wizard-question">Bystander CPR?</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="oohcaBystander" data-value="bystander">Yes</button>
                        <button class="wizard-option" data-field="oohcaBystander" data-value="noBystander">No</button>
                    </div>
                    <button class="wizard-back" onclick="progBack('oohca-4')"> Back</button>
                </div>
                
                <!-- OOHCA Step 5: Duration -->
                <div class="wizard-step" data-step="oohca-5">
                    <div class="wizard-question">Duration of professional CPR?</div>
                    <div class="wizard-subtitle">Not time of collapse</div>
                    <div class="wizard-number-input">
                        <select id="oohcaMinsWizard"></select>
                        <span>minutes</span>
                    </div>
                    <label class="auto-sync-toggle" style="justify-content: center; margin-bottom: 20px;">
                        <input type="checkbox" id="oohcaAutoSyncWizard">
                        <span class="toggle-label">Use current resuscitation duration</span>
                    </label>
                    <button class="wizard-next" id="oohcaShowResult">Show Prognosis</button>
                    <button class="wizard-back" onclick="progBack('oohca-5')"> Back</button>
                </div>
                
                <!-- OOHCA Result -->
                <div class="wizard-step" data-step="oohca-result">
                    <div class="wizard-result">
                        <div class="wizard-result-label">Survival with good neurological outcome (mRS 0-3)</div>
                        <div class="wizard-result-value" id="oohcaResultWizard"></div>
                        <div class="wizard-result-label" id="oohcaResultNote" style="font-size: 1rem; margin-top: 8px;"></div>
                    </div>
                    <div class="wizard-footer">
                        <strong>Data source:</strong> Reynolds et al. Circulation 2016 (ROC-PRIMED)<br>
                        11,368 adult out-of-hospital cardiac arrests across 10 North American sites from 20072010.<br><br>
                        <strong>This is not a termination of resuscitation rule.</strong> Use validated TOR criteria for cessation decisions.
                    </div>
                    <button class="wizard-back" onclick="progBack('oohca-result')"> Back</button>
                    <button class="wizard-reset" onclick="progReset()">Start Over</button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-ecpr">
            <div class="wizard" id="ecprWizard">
                <div class="wizard-progress" id="ecprProgress">
                    <div class="wizard-progress-dot current"></div>
                    <div class="wizard-progress-dot"></div>
                    <div class="wizard-progress-dot"></div>
                    <div class="wizard-progress-dot"></div>
                    <div class="wizard-progress-dot"></div>
                    <div class="wizard-progress-dot"></div>
                </div>
                
                <!-- Step 1: Age -->
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-question">Patient age?</div>
                    <div class="wizard-subtitle">Used to calculate max CPR duration for ECMO</div>
                    <div class="wizard-number-input">
                        <select id="ecprAgeWizard">
                            <option value="" disabled selected>Select</option>
                        </select>
                        <span>years</span>
                    </div>
                    <div id="ecprAgeWizardWarning" style="text-align: center; color: #ff6b6b; margin-bottom: 16px;"></div>
                    <button class="wizard-next" id="ecprNext1" disabled>Next</button>
                </div>
                
                <!-- Step 2: Time -->
                <div class="wizard-step" data-step="2">
                    <div class="wizard-question" id="ecprTimeQuestion">Can ECMO decision be made in time?</div>
                    <div class="wizard-subtitle">100 - age = max minutes of CPR</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="withinTime" data-value="yes">Yes</button>
                        <button class="wizard-option" data-field="withinTime" data-value="no">No</button>
                    </div>
                    <button class="wizard-back" onclick="ecprBack(2)"> Back</button>
                </div>
                
                <!-- Step 3: Witnessed -->
                <div class="wizard-step" data-step="3">
                    <div class="wizard-question">Witnessed arrest?</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="witnessed" data-value="yes">Yes</button>
                        <button class="wizard-option" data-field="witnessed" data-value="no">No</button>
                    </div>
                    <button class="wizard-back" onclick="ecprBack(3)"> Back</button>
                </div>
                
                <!-- Step 4: Shockable -->
                <div class="wizard-step" data-step="4">
                    <div class="wizard-question">Shockable initial rhythm?</div>
                    <div class="wizard-subtitle">VF or pulseless VT</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="shockable" data-value="yes">Yes</button>
                        <button class="wizard-option" data-field="shockable" data-value="no">
                            No
                            <div class="wizard-option-hint">Non-shockable may still qualify if hypothermia &lt;32C or drug intoxication</div>
                        </button>
                    </div>
                    <button class="wizard-back" onclick="ecprBack(4)"> Back</button>
                </div>
                
                <!-- Step 5: Bystander -->
                <div class="wizard-step" data-step="5">
                    <div class="wizard-question">Bystander CPR within 5 mins?</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="bystander" data-value="yes">Yes</button>
                        <button class="wizard-option" data-field="bystander" data-value="no">No</button>
                    </div>
                    <button class="wizard-back" onclick="ecprBack(5)"> Back</button>
                </div>
                
                <!-- Step 6: End-stage -->
                <div class="wizard-step" data-step="6">
                    <div class="wizard-question">Free of end-stage disease?</div>
                    <div class="wizard-subtitle">No terminal illness or severe comorbidity</div>
                    <div class="wizard-options">
                        <button class="wizard-option" data-field="noEndStage" data-value="yes">Yes</button>
                        <button class="wizard-option" data-field="noEndStage" data-value="no">No</button>
                    </div>
                    <button class="wizard-back" onclick="ecprBack(6)"> Back</button>
                </div>
                
                <!-- Result -->
                <div class="wizard-step" data-step="7">
                    <button class="wizard-back" onclick="ecprBack(7)"> Back</button>
                    <div class="wizard-result">
                        <div class="wizard-result-label">Survival if VA-ECMO initiated</div>
                        <div class="wizard-result-value" id="ecprWizardResult"></div>
                        <div class="wizard-result-label" id="ecprWizardCriteria"></div>
                    </div>
                    <div class="wizard-footer">
                        <strong>Factors favouring inclusion:</strong> Signs of life, any ROSC period<br><br>
                        <strong>Factors favouring exclusion:</strong> Age >65, EtCO <10, femoral access impossible, aortic regurgitation, suspected aortic dissection
                    </div>
                    <button class="wizard-reset" onclick="ecprReset()">Start Over</button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-log">
            <div class="log-page">
                <div class="log-summary" id="logSummary" style="display: none;">
                    <h4>Summary</h4>
                    <div class="log-summary-content" id="logSummaryContent"></div>
                    <button class="btn-copy-summary" id="btnCopySummary">Copy Summary</button>
                </div>
                <div class="log-header">
                    <h3>Event Log</h3>
                    <button class="btn-copy" id="btnCopyLog">Copy</button>
                </div>
                <div class="log-entries" id="logEntries">
                    <p class="log-empty">No events logged yet</p>
                </div>
                <div class="copyright"> 2025 Scott Santinon</div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-info">
            <div class="info-page">
                <h3>CodeClock</h3>
                <p class="info-version">Terms of Use, Disclaimer & Privacy Policy<br>Version 1.0  December 2025</p>
                
                <div class="info-warning">
                    <strong>IMPORTANT:</strong> Please read these terms carefully before using this application. By using CodeClock, you acknowledge that you have read, understood, and agree to be bound by these terms. If you do not agree, do not use this application.
                </div>
                
                <h4>1. Intended Users</h4>
                <p>CodeClock is designed <strong>exclusively for use by qualified healthcare professionals</strong> who have received appropriate training in cardiopulmonary resuscitation (CPR), advanced life support (ALS), and emergency medical care. This includes, but is not limited to, physicians, nurses, paramedics, and other licensed medical practitioners.</p>
                <p>This application is <strong>not intended for use by the general public</strong> or by individuals without formal medical training. If you are not a qualified healthcare professional, do not use this application in a medical emergencyinstead, call emergency services immediately.</p>
                
                <h4>2. Purpose & Intended Use</h4>
                <p>CodeClock is a <strong>reference and timing tool</strong> designed to assist qualified healthcare professionals during cardiac arrest resuscitation. The application provides:</p>
                <p> Timers for CPR cycles and medication intervals<br>
                 Reference information for drug dosages<br>
                 Prognostic information based on published research<br>
                 Checklists for reversible causes<br>
                 Event logging functionality</p>
                <p>This application is intended to <strong>supplementnot replaceclinical training, professional judgment, and established protocols</strong>. It is a cognitive aid only.</p>
                
                <h4>3. Not Medical Advice</h4>
                <p>The information provided in this application is for <strong>general informational and educational purposes only</strong>. It does not constitute medical advice, diagnosis, or treatment recommendations.</p>
                <p><strong>Nothing in this application creates a physician-patient, provider-patient, or any other healthcare relationship</strong> between the developer and any user or patient.</p>
                <p>Clinical decisions must always be made by the treating healthcare professional based on their own assessment, training, local protocols, and the specific circumstances of each patient.</p>
                
                <h4>4. Clinical Judgment Prevails</h4>
                <div class="info-warning">
                    <strong>Your professional clinical judgment must always take precedence over any information displayed in this application.</strong> If there is any conflict between the application and your clinical assessment, local protocols, or current guidelines, you must rely on your professional judgment and disregard the application.
                </div>
                <p>Healthcare professionals are responsible for:</p>
                <p> Verifying all drug dosages before administration<br>
                 Confirming timing intervals against current guidelines<br>
                 Assessing each patient individually<br>
                 Following their institution's protocols and policies<br>
                 Staying current with the latest resuscitation guidelines</p>
                
                <h4>5. Sources & Methodology</h4>
                <p>The clinical information in this application is based on:</p>
                <p><strong>Timing protocols:</strong> Australian and New Zealand Committee on Resuscitation (ANZCOR) Guidelines</p>
                <p><strong>In-hospital cardiac arrest prognosis:</strong> Okubo et al., BMJ 2024  survival probability data extracted from published Kaplan-Meier curves</p>
                <p><strong>Out-of-hospital cardiac arrest prognosis:</strong> Reynolds et al., Circulation 2016  probability ranges derived from published survival curves</p>
                <p><strong>E-CPR criteria:</strong> Based on published inclusion criteria from E-CPR programs</p>
                <p><strong>Drug dosages:</strong> Standard adult doses from established resuscitation guidelines</p>
                <p>Prognostic calculations provide <strong>approximate probability ranges</strong> based on population-level data and may not reflect individual patient outcomes. These are provided as decision-support information only and should not be the sole basis for clinical decisions.</p>
                
                <h4>6. No Warranty</h4>
                <p>This application is provided <strong>"AS IS" and "AS AVAILABLE"</strong> without warranty of any kind, either express or implied, including but not limited to:</p>
                <p> Warranties of merchantability<br>
                 Fitness for a particular purpose<br>
                 Accuracy, reliability, or completeness of information<br>
                 Non-infringement<br>
                 Uninterrupted or error-free operation</p>
                <p>The developer does not warrant that:</p>
                <p> The application will meet your requirements<br>
                 The application will be available at all times<br>
                 The information is current, complete, or accurate<br>
                 Any errors will be corrected<br>
                 The application is free from viruses or harmful components</p>
                
                <h4>7. Limitation of Liability</h4>
                <p><strong>To the maximum extent permitted by applicable law</strong>, the developer, contributors, and any affiliated parties shall not be liable for any direct, indirect, incidental, special, consequential, or punitive damages, including but not limited to:</p>
                <p> Personal injury or death<br>
                 Loss of profits, data, or goodwill<br>
                 Medical malpractice claims<br>
                 Damages arising from reliance on the application<br>
                 Damages arising from errors, omissions, or inaccuracies<br>
                 Damages arising from interruption or unavailability<br>
                 Any other damages arising from the use or inability to use this application</p>
                <p>This limitation applies regardless of the legal theory (contract, tort, negligence, strict liability, or otherwise), even if the developer has been advised of the possibility of such damages.</p>
                <p><strong>Some jurisdictions do not allow the exclusion of certain warranties or limitation of liability for certain damages. In such jurisdictions, the developer's liability shall be limited to the maximum extent permitted by law.</strong></p>
                
                <h4>8. Assumption of Risk</h4>
                <p>By using this application, you expressly acknowledge and agree that:</p>
                <p> You use this application <strong>entirely at your own risk</strong><br>
                 You are solely responsible for any clinical decisions made<br>
                 You will verify all information independently before relying on it<br>
                 You accept full responsibility for patient outcomes<br>
                 The developer bears no responsibility for clinical outcomes</p>
                
                <h4>9. Indemnification</h4>
                <p>You agree to <strong>indemnify, defend, and hold harmless</strong> the developer and any affiliated parties from and against any and all claims, damages, losses, liabilities, costs, and expenses (including reasonable legal fees) arising from or related to:</p>
                <p> Your use of the application<br>
                 Your violation of these terms<br>
                 Your violation of any rights of another party<br>
                 Any claim that your use of the application caused damage to a third party<br>
                 Any medical malpractice or negligence claims related to your use of the application</p>
                
                <h4>10. Not a Medical Device</h4>
                <p>This application is <strong>not a medical device</strong> and has not been cleared or approved by the Therapeutic Goods Administration (TGA), Food and Drug Administration (FDA), or any other regulatory body. It does not:</p>
                <p> Diagnose, treat, cure, or prevent any disease<br>
                 Monitor vital signs or physiological parameters<br>
                 Connect to or control any medical equipment<br>
                 Make autonomous clinical decisions</p>
                <p>This application is a software tool that displays reference information and timing functions only.</p>
                
                <h4>11. Updates & Changes</h4>
                <p>Medical guidelines and best practices evolve over time. The developer:</p>
                <p> Makes no commitment to update the application<br>
                 May modify or discontinue the application at any time<br>
                 May update these terms at any time</p>
                <p>It is your responsibility to ensure you are using the most current version and to verify that the information aligns with current guidelines.</p>
                
                <h4>12. Privacy Policy</h4>
                <div class="info-box">
                    <p><strong>Data Collection:</strong> This application does not collect, store, transmit, or share any personal data, health information, or usage analytics.</p>
                    <p><strong>Local Storage:</strong> All data (event logs, settings) is stored locally on your device only and is not accessible to the developer or any third party.</p>
                    <p><strong>Network Access:</strong> This application functions entirely offline. No internet connection is required or used during operation.</p>
                    <p><strong>Third Parties:</strong> This application does not integrate with any third-party analytics, advertising, or data collection services.</p>
                </div>
                
                <h4>13. Intellectual Property</h4>
                <p> 2025 Scott Santinon. All rights reserved.</p>
                <p>The CodeClock name, design, and content are protected by copyright and other intellectual property laws. You may not copy, modify, distribute, or create derivative works without prior written permission.</p>
                
                <h4>14. Governing Law</h4>
                <p>These terms shall be governed by and construed in accordance with the laws of <strong>Victoria, Australia</strong>, without regard to its conflict of law provisions. Any disputes arising from these terms or your use of the application shall be subject to the exclusive jurisdiction of the courts of Victoria, Australia.</p>
                
                <h4>15. Severability</h4>
                <p>If any provision of these terms is found to be unenforceable or invalid, that provision shall be limited or eliminated to the minimum extent necessary so that these terms shall otherwise remain in full force and effect.</p>
                
                <h4>16. Entire Agreement</h4>
                <p>These terms constitute the entire agreement between you and the developer regarding the use of this application and supersede all prior agreements and understandings.</p>
                
                <h4>17. Contact</h4>
                <p>For questions about these terms or the application, please contact: <strong><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b6c5d5d9c2c298c5d7d8c2dfd8d9d8f6d1dbd7dfda98d5d9db">[email&#160;protected]</a></strong></p>
                
                <div class="info-accept">
                    <strong>By using CodeClock, you confirm that:</strong><br>
                     You are a qualified healthcare professional<br>
                     You have read and understood these terms<br>
                     You agree to be bound by these terms<br>
                     You accept full responsibility for clinical decisions
                </div>
                
                <p class="info-version" style="margin-top: 24px;">Last updated: December 2025</p>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="updateTimeModal">
        <div class="modal">
            <h2>Update Arrest Time</h2>
            <p>Update time of arrest to</p>
            <div class="start-time-display" style="margin: 16px 0;">
                <input type="time" class="time-picker" id="updateTime">
            </div>
            <button class="btn-modal btn-green" id="btnConfirmUpdate">Update</button>
            <button class="btn-modal btn-gray" id="btnCancelUpdate">Cancel</button>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="ecprModal">
        <div class="modal">
            <h2>E-CPR Assessment</h2>
            <p style="margin-bottom: 24px; font-size: 1.1rem; line-height: 1.5;">Should you call for ECMO?</p>
            <button class="btn-modal btn-green" id="ecprYes">Yes</button>
            <button class="btn-modal btn-teal" id="ecprAssess">Check criteria</button>
            <button class="btn-modal btn-orange" id="ecprRemind">Remind 5 min</button>
            <button class="btn-modal btn-gray" id="ecprNo">Not appropriate / Not available</button>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="amioModal">
        <div class="modal">
            <h2 id="amioTitle">3rd Shock</h2>
            <div class="amio-alert">
                <p id="amioDose">Amiodarone 300mg IV</p>
            </div>
            <button class="btn-modal btn-green" id="amioGiven">Given</button>
            <button class="btn-modal btn-gray" id="amioOmitted">Omitted</button>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="shockConfirmModal">
        <div class="modal">
            <h2>Shockable Rhythm</h2>
            <button class="btn-modal btn-orange" id="shockYes">Shock given</button>
            <button class="btn-modal btn-gray" id="shockNo">No shock</button>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="adrenalineReminderModal">
        <div class="modal">
            <h2 id="adrReminderTitle">Adrenaline</h2>
            <p id="adrReminderContext" class="modal-context"></p>
            <button class="btn-modal btn-green" id="adrReminderYes">Given</button>
            <button class="btn-modal btn-gray" id="adrReminderOmit">Skipped</button>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="roscHistoryModal">
        <div class="modal">
            <h2>ROSC History</h2>
            <div id="roscHistoryContent"></div>
            <button class="btn-modal btn-gray" id="roscHistoryClose">Close</button>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    (function() {
        var resusStarted = false;
        var totalSeconds = 0;
        var arrestStartTime = null;
        var cprSeconds = 120;
        var rhythmCheckStarted = false;
        var adrenalineSeconds = 240;
        var adrenalineStarted = false;
        var adrenalineCount = 0;
        var shockCount = 0;
        var rhythmCheckCount = 0;
        var ecprPromptDismissed = false;
        var ecprRemindTime = null;
        var htChecked = {};
        var log = [];
        var timerInterval = null;
        var roscActive = false;
        var roscTimeStr = null;
        var roscStartTime = null;
        var roscHistory = [];
        var wakeLock = null;
        
        var calcAge = null;
        var calcWitnessed = null;
        var calcRhythm = null;
        var calcMins = 0;
        
        var ecprData = { withinTime: null, witnessed: null, shockable: null, bystander: null, noEndStage: null };
        var amiodaroneGiven = false;
        var isShockableRhythm = null;
        var joinedMidArrest = false;
        
        // Prognosis data from Okubo et al. BMJ 2024 (n=348,996 IHCA)
        // Time-dependent probability among patients pending first ROSC at each minute
        
        // Favorable functional outcome (CPC 1-2) - Figure 8
        // Good neurological outcome data from Okubo et al. BMJ 2024 - using ranges
        var favorableOutcomeData = {
            '<60': { 
                'witnessed-shockable': { 1: '>30%', 10: '10-20%', 20: '5-10%', 30: '2-5%', 40: '2-5%', 50: '<2%', 60: '<1%' }, 
                'witnessed-nonshockable': { 1: '10-20%', 10: '5-10%', 20: '2-5%', 30: '<2%', 40: '<1%', 50: '<1%', 60: '<1%' }, 
                'unwitnessed-shockable': { 1: '>30%', 10: '10-20%', 20: '5-10%', 30: '2-5%', 40: '<2%', 50: '<1%', 60: '<1%' }, 
                'unwitnessed-nonshockable': { 1: '10-20%', 10: '2-5%', 20: '<2%', 30: '<1%', 40: '<1%', 50: '<1%', 60: '<1%' } 
            },
            '60-79': { 
                'witnessed-shockable': { 1: '>30%', 10: '10-20%', 20: '5-10%', 30: '2-5%', 40: '<2%', 50: '<1%', 60: '<1%' }, 
                'witnessed-nonshockable': { 1: '10-20%', 10: '2-5%', 20: '2-5%', 30: '<1%', 40: '<1%', 50: '<1%', 60: '<1%' }, 
                'unwitnessed-shockable': { 1: '20-30%', 10: '5-10%', 20: '2-5%', 30: '<2%', 40: '<1%', 50: '<1%', 60: '<1%' }, 
                'unwitnessed-nonshockable': { 1: '5-10%', 10: '2-5%', 20: '<1%', 30: '<1%', 40: '<1%', 50: '<1%', 60: '<1%' } 
            },
            '>=80': { 
                'witnessed-shockable': { 1: '20-30%', 10: '5-10%', 20: '2-5%', 30: '<2%', 40: '<1%', 50: '<1%', 60: '<1%' }, 
                'witnessed-nonshockable': { 1: '5-10%', 10: '2-5%', 20: '<2%', 30: '<1%', 40: '<1%', 50: '<1%', 60: '<1%' }, 
                'unwitnessed-shockable': { 1: '10-20%', 10: '5-10%', 20: '2-5%', 30: '<1%', 40: '<1%', 50: '<1%', 60: '<1%' }, 
                'unwitnessed-nonshockable': { 1: '2-5%', 10: '<2%', 20: '<1%', 30: '<1%', 40: '<1%', 50: '<1%', 60: '<1%' } 
            }
        };
        
        // Survival to hospital discharge - Okubo et al. BMJ 2024 - using ranges
        var survivalData = {
            '<60': { 
                'witnessed-shockable': { 1: '>30%', 10: '20-30%', 20: '10-20%', 30: '5-10%', 40: '2-5%', 50: '<2%', 60: '<2%' }, 
                'witnessed-nonshockable': { 1: '20-30%', 10: '5-10%', 20: '2-5%', 30: '<2%', 40: '<2%', 50: '<1%', 60: '<1%' }, 
                'unwitnessed-shockable': { 1: '>30%', 10: '10-20%', 20: '10-20%', 30: '2-5%', 40: '2-5%', 50: '<2%', 60: '<1%' }, 
                'unwitnessed-nonshockable': { 1: '10-20%', 10: '5-10%', 20: '2-5%', 30: '<2%', 40: '<1%', 50: '<1%', 60: '<1%' } 
            },
            '60-79': { 
                'witnessed-shockable': { 1: '>30%', 10: '10-20%', 20: '5-10%', 30: '2-5%', 40: '2-5%', 50: '<2%', 60: '<1%' }, 
                'witnessed-nonshockable': { 1: '10-20%', 10: '5-10%', 20: '2-5%', 30: '<2%', 40: '<1%', 50: '<1%', 60: '<1%' }, 
                'unwitnessed-shockable': { 1: '>30%', 10: '10-20%', 20: '5-10%', 30: '2-5%', 40: '<2%', 50: '<2%', 60: '<1%' }, 
                'unwitnessed-nonshockable': { 1: '10-20%', 10: '5-10%', 20: '2-5%', 30: '<1%', 40: '<1%', 50: '<1%', 60: '<1%' } 
            },
            '>=80': { 
                'witnessed-shockable': { 1: '20-30%', 10: '10-20%', 20: '5-10%', 30: '2-5%', 40: '<2%', 50: '<1%', 60: '<1%' }, 
                'witnessed-nonshockable': { 1: '10-20%', 10: '5-10%', 20: '<2%', 30: '<1%', 40: '<1%', 50: '<1%', 60: '<1%' }, 
                'unwitnessed-shockable': { 1: '20-30%', 10: '10-20%', 20: '2-5%', 30: '<1%', 40: '<1%', 50: '<1%', 60: '<1%' }, 
                'unwitnessed-nonshockable': { 1: '5-10%', 10: '2-5%', 20: '<2%', 30: '<1%', 40: '<1%', 50: '<1%', 60: '<1%' } 
            }
        };
        
        // OOHCA Prognosis data from Reynolds et al. Circulation 2016 (ROC-PRIMED)
        // Values digitized from Figure 4 - probability bands by phenotype and CPR duration
        var oohcaPrognosis = {
            'shockable_witnessed_bystander':       { 5: '20-30%', 10: '20-30%', 15: '10-20%', 20: '10-20%', 30: '5-10%', 40: '2-5%' },
            'shockable_witnessed_noBystander':     { 5: '20-30%', 10: '10-20%', 15: '5-10%', 20: '5-10%', 30: '5-10%', 40: '2-5%' },
            'shockable_unwitnessed_bystander':     { 5: '10-20%', 10: '5-10%', 15: '5-10%', 20: '2-5%', 30: '1-2%', 40: '2-5%' },
            'shockable_unwitnessed_noBystander':   { 5: '10-20%', 10: '5-10%', 15: '5-10%', 20: '2-5%', 30: '<1%', 40: '<1%' },
            'nonshockable_witnessed_bystander':    { 5: '2-5%', 10: '1-2%', 15: '1-2%', 20: '<1%', 30: '<1%', 40: '<1%' },
            'nonshockable_witnessed_noBystander':  { 5: '2-5%', 10: '1-2%', 15: '1-2%', 20: '<1%', 30: '<1%', 40: '<1%' },
            'nonshockable_unwitnessed_bystander':  { 5: '<2%', 10: '<2%', 15: '<1%', 20: '<1%', 30: '<1%', 40: '<1%' },
            'nonshockable_unwitnessed_noBystander':{ 5: '<2%', 10: '<2%', 15: '<1%', 20: '<1%', 30: '<1%', 40: '<1%' }
        };
        
        // OOHCA calculator state
        var oohcaRhythm = null; // 'shockable' or 'nonshockable'
        var oohcaWitnessed = null; // 'witnessed' or 'unwitnessed'
        var oohcaBystander = null; // 'bystander' or 'noBystander'
        var oohcaMins = 0;
        var oohcaAutoSync = false;
        
        function $(id) { return document.getElementById(id); }
        
        function formatTime(seconds) {
            var sign = seconds < 0 ? '+' : '';
            var mins = Math.floor(Math.abs(seconds) / 60);
            var secs = Math.abs(seconds) % 60;
            return sign + mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        function formatTimeHMS(seconds) {
            var hrs = Math.floor(seconds / 3600);
            var mins = Math.floor((seconds % 3600) / 60);
            var secs = seconds % 60;
            if (hrs > 0) return hrs + ':' + (mins < 10 ? '0' : '') + mins + ':' + (secs < 10 ? '0' : '') + secs;
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        function vibrate(pattern) { if (navigator.vibrate) navigator.vibrate(pattern); }
        
        // Audio alerts using Web Audio API
        // DEVELOPER NOTE: iOS Audio Session Configuration
        // This is an emergency medical app - audio alerts MUST play even when device is in silent mode.
        // For native iOS app, configure AVAudioSession to ignore the silent switch:
        //
        //   do {
        //       try AVAudioSession.sharedInstance().setCategory(.playback, mode: .default, options: [])
        //       try AVAudioSession.sharedInstance().setActive(true)
        //   } catch {
        //       print("Failed to configure audio session: \(error)")
        //   }
        //
        // The .playback category ignores the ringer/silent switch.
        // Do NOT use .ambient or .soloAmbient as they respect silent mode.
        // Consider also enabling background audio capability if alerts should sound when app is backgrounded.
        //
        var audioContext = null;
        function playAlert(type) {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                var osc = audioContext.createOscillator();
                var gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                if (type === 'rhythm') {
                    // Triple beep for rhythm check
                    osc.frequency.value = 880; // A5
                    gain.gain.value = 0.3;
                    osc.start();
                    gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain.gain.setValueAtTime(0, audioContext.currentTime + 0.15);
                    gain.gain.setValueAtTime(0.3, audioContext.currentTime + 0.25);
                    gain.gain.setValueAtTime(0, audioContext.currentTime + 0.4);
                    gain.gain.setValueAtTime(0.3, audioContext.currentTime + 0.5);
                    gain.gain.setValueAtTime(0, audioContext.currentTime + 0.65);
                    osc.stop(audioContext.currentTime + 0.7);
                } else if (type === 'adrenaline') {
                    // Double lower tone for adrenaline
                    osc.frequency.value = 660; // E5
                    gain.gain.value = 0.3;
                    osc.start();
                    gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain.gain.setValueAtTime(0, audioContext.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.3, audioContext.currentTime + 0.35);
                    gain.gain.setValueAtTime(0, audioContext.currentTime + 0.55);
                    osc.stop(audioContext.currentTime + 0.6);
                }
            } catch (e) {
                // Audio not supported
            }
        }
        
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {
                    // Wake lock request failed (e.g., low battery)
                }
            }
        }
        
        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }
        
        // Reveal full UI after first rhythm check
        function revealFullUI() {
            var timerPage = document.querySelector('.timer-page');
            if (timerPage.classList.contains('initial-state')) {
                timerPage.classList.remove('initial-state');
                $('timerGrid').classList.remove('hidden');
                $('btnRosc').classList.remove('hidden');
                $('btnRoscHistory').classList.remove('hidden');
                $('btnTerminate').classList.remove('hidden');
            }
        }
        
        // Color constants (matching CSS variables)
        var COLOR_GREEN = '#44ff44';
        var COLOR_RED = '#ff4444';
        var COLOR_ORANGE = '#ffa500';
        
        function getTimerColor(remaining) {
            if (remaining <= 0) return COLOR_RED;
            if (remaining <= 10) return COLOR_RED;
            if (remaining <= 30) return COLOR_ORANGE;
            return COLOR_GREEN;
        }
        
        function getAdrenalineColor(remaining) {
            if (remaining <= 0) return COLOR_RED;
            if (remaining <= 10) return COLOR_RED;
            if (remaining <= 30) return COLOR_ORANGE;
            return '#666'; // Neutral, not green - reduces visual competition
        }
        
        function addLog(event) {
            var now = new Date();
            var timeStr = now.toTimeString().slice(0, 5);
            log.push({ time: timeStr, event: event });
            renderLog();
            updateLogSummary();
        }
        
        function updateLogSummary() {
            if (log.length === 0) {
                $('logSummary').style.display = 'none';
                return;
            }
            
            $('logSummary').style.display = 'block';
            
            // Build summary
            var lines = [];
            
            // Arrest time
            if (arrestStartTime) {
                lines.push('Arrest time: ' + arrestStartTime.toTimeString().slice(0, 5));
            }
            
            // Duration
            var mins = Math.floor(totalSeconds / 60);
            var secs = totalSeconds % 60;
            lines.push('Duration: ' + mins + ' min ' + secs + ' sec');
            
            // Initial rhythm (find first VF/VT or PEA entry)
            var initialRhythm = null;
            for (var i = 0; i < log.length; i++) {
                if (log[i].event.indexOf('VF/VT') !== -1) {
                    initialRhythm = 'VF/VT (shockable)';
                    break;
                } else if (log[i].event.indexOf('PEA') !== -1 || log[i].event.indexOf('Asystole') !== -1) {
                    initialRhythm = 'PEA/Asystole (non-shockable)';
                    break;
                }
            }
            if (initialRhythm) {
                lines.push('Initial rhythm: ' + initialRhythm);
            }
            
            // Shocks
            if (shockCount > 0) {
                lines.push('Shocks delivered: ' + shockCount);
            }
            
            // Adrenaline
            if (adrenalineCount > 0) {
                lines.push('Adrenaline doses: ' + adrenalineCount);
            }
            
            // ROSC periods
            if (roscHistory.length > 0) {
                var roscSummary = roscHistory.map(function(r) {
                    return r.duration + ' (' + r.start + '' + r.end + ')';
                }).join(', ');
                lines.push('ROSC periods: ' + roscSummary);
            }
            if (roscActive) {
                lines.push('Current status: ROSC (ongoing from ' + roscTimeStr + ')');
            }
            
            // Key decisions from log
            var keyEvents = [];
            log.forEach(function(entry) {
                if (entry.event.indexOf('E-CPR:') !== -1) {
                    keyEvents.push(entry.time + ' ' + entry.event);
                }
            });
            if (keyEvents.length > 0) {
                lines.push('');
                lines.push('Key decisions:');
                keyEvents.forEach(function(e) { lines.push('  ' + e); });
            }
            
            $('logSummaryContent').textContent = lines.join('\n');
        }
        
        // Update header size based on active tab
        function updateHeaderSize() {
            // Tabs always stay expanded (larger) regardless of which tab is active
            var tabs = document.querySelector('.tabs');
            tabs.classList.add('expanded');
            // Header stays at default (smaller) size - no expanded class
        }
        
        // Tab switching
        document.querySelectorAll('.tab-btn:not(.tab-more-btn)').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
                document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
                btn.classList.add('active');
                $('tab-' + btn.getAttribute('data-tab')).classList.add('active');
                $('tabMoreMenu').classList.add('hidden');
                updateHeaderSize();
            });
        });
        
        // More menu toggle
        $('tabMoreBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            $('tabMoreMenu').classList.toggle('hidden');
        });
        
        // More menu items
        document.querySelectorAll('.tab-more-item').forEach(function(item) {
            item.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
                document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
                $('tabMoreBtn').classList.add('active');
                $('tab-' + item.getAttribute('data-tab')).classList.add('active');
                $('tabMoreMenu').classList.add('hidden');
                updateHeaderSize();
            });
        });
        
        // Initialize header size
        updateHeaderSize();
        
        // Close More menu when clicking elsewhere
        document.addEventListener('click', function() {
            $('tabMoreMenu').classList.add('hidden');
        });
        
        // Start resuscitation (fresh arrest)
        function startFreshArrest() {
            arrestStartTime = new Date();
            arrestStartTime.setSeconds(0);
            resusStarted = true;
            addLog('Resuscitation started');
            requestWakeLock();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(tick, 1000);
            updateDisplay();
            $('landingScreen').classList.add('hidden');
            $('app').classList.remove('hidden');
        }
        
        // Start resuscitation (mid-arrest join)
        function startMidArrest(setupData) {
            joinedMidArrest = true;
            var now = new Date();
            
            // Set arrest start time
            arrestStartTime = new Date(setupData.arrestTime);
            
            // Zero seconds on both times so preset durations are accurate
            // (e.g., "3 mins ago" should show ~3:00, not 3:45)
            now.setSeconds(0);
            now.setMilliseconds(0);
            arrestStartTime.setSeconds(0);
            arrestStartTime.setMilliseconds(0);
            
            totalSeconds = Math.floor((now - arrestStartTime) / 1000);
            
            // Set shock count and rhythm
            shockCount = setupData.shocks;
            isShockableRhythm = setupData.isShockable;
            
            // Set amiodarone state
            amiodaroneGiven = setupData.amiodaroneGiven || false;
            
            // Set adrenaline state
            adrenalineCount = setupData.adrenalineCount;
            
            // Backfill log
            var startTimeStr = formatTime(0);
            log.push({ time: startTimeStr, event: 'Resuscitation started' });
            log.push({ time: startTimeStr, event: 'Joined mid-arrest (' + Math.floor(totalSeconds / 60) + ' minutes in)' });
            
            if (shockCount > 0) {
                log.push({ time: startTimeStr, event: 'Initial rhythm: Shockable (VF/VT)' });
                log.push({ time: startTimeStr, event: 'Shocks prior to arrival: ' + shockCount });
            } else if (isShockableRhythm === true) {
                log.push({ time: startTimeStr, event: 'Initial rhythm: Shockable (VF/VT)' });
            } else if (isShockableRhythm === false) {
                log.push({ time: startTimeStr, event: 'Initial rhythm: Non-shockable (PEA/Asystole)' });
            }
            
            if (amiodaroneGiven) {
                log.push({ time: startTimeStr, event: 'Amiodarone given prior to arrival' });
            }
            
            if (adrenalineCount > 0) {
                log.push({ time: startTimeStr, event: 'Adrenaline given prior to arrival' });
            }
            
            // Start timers
            resusStarted = true;
            requestWakeLock();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(tick, 1000);
            
            // Hide landing, show app
            $('landingScreen').classList.add('hidden');
            $('app').classList.remove('hidden');
            
            // Remove initial-state styling for mid-arrest join
            document.querySelector('.timer-page').classList.remove('initial-state');
            
            // Handle rhythm state
            if (setupData.rhythmNotChecked) {
                // Show rhythm check buttons (same as fresh arrest)
                rhythmCheckStarted = false;
                updateDisplay();
            } else {
                // Skip rhythm check screen, go straight to timers
                rhythmCheckStarted = true;
                $('rhythmCheckBox').classList.add('hidden');
                $('timerGrid').classList.remove('hidden');
                $('btnRosc').classList.remove('hidden');
                $('btnRoscHistory').classList.remove('hidden');
                $('btnTerminate').classList.remove('hidden');
                $('headerTapHint').classList.remove('hidden');
                
                if (isShockableRhythm) {
                    $('shockCounter').classList.remove('hidden');
                    $('shockCount').textContent = shockCount;
                }
                
                // Set up adrenaline timer based on state
                if (setupData.adrenalineState === 'given') {
                    adrenalineStarted = true;
                    adrenalineSeconds = 240;
                    $('adrenalineTime').textContent = '4:00';
                    $('adrNote').textContent = 'Tap when given';
                } else if (setupData.adrenalineState === 'due') {
                    adrenalineStarted = true;
                    adrenalineSeconds = 60;
                    $('adrenalineTime').textContent = '1:00';
                    $('adrNote').textContent = 'Tap when given';
                } else {
                    // None yet - check if should be due now
                    var adrenalineDueNow = false;
                    if (!isShockableRhythm) {
                        // Non-shockable: adrenaline due immediately
                        adrenalineDueNow = true;
                    } else if (shockCount >= 2) {
                        // Shockable with 2+ shocks: adrenaline due
                        adrenalineDueNow = true;
                    }
                    
                    if (adrenalineDueNow) {
                        adrenalineStarted = true;
                        adrenalineSeconds = 0;
                        $('adrenalineTime').textContent = 'DUE';
                        $('adrNote').textContent = 'Tap when given';
                        $('adrenalineTimer').classList.add('overdue');
                    } else {
                        // Waiting for 2nd shock
                        $('adrenalineTime').textContent = 'TAP';
                        $('adrNote').textContent = 'After 2nd shock';
                    }
                }
                
                updateDisplay();
                
                // Trigger popups after short delay
                setTimeout(function() {
                    // Adrenaline popup if needed
                    if (setupData.adrenalineState === 'none') {
                        var needsAdrenalinePopup = false;
                        var adrContext = '';
                        if (!isShockableRhythm) {
                            needsAdrenalinePopup = true;
                            adrContext = 'Non-shockable rhythm';
                        } else if (shockCount >= 2) {
                            needsAdrenalinePopup = true;
                            adrContext = shockCount + ' shocks given';
                        }
                        if (needsAdrenalinePopup) {
                            $('adrReminderTitle').textContent = 'Adrenaline';
                            $('adrReminderContext').textContent = adrContext;
                            $('adrenalineReminderModal').classList.remove('hidden');
                        }
                    }
                    
                    // Amiodarone popup if needed (after adrenaline handled)
                    setTimeout(function() {
                        if (shockCount >= 3 && !amiodaroneGiven) {
                            if (shockCount === 3) {
                                $('amioTitle').textContent = '3rd Shock';
                                $('amioDose').textContent = 'Amiodarone 300mg IV';
                            } else if (shockCount === 5) {
                                $('amioTitle').textContent = '5th Shock';
                                $('amioDose').textContent = 'Amiodarone 150mg IV';
                            } else {
                                $('amioTitle').textContent = 'Shock #' + shockCount;
                                $('amioDose').textContent = 'Amiodarone 150mg IV (if not already given)';
                            }
                            $('amioModal').classList.remove('hidden');
                        }
                    }, 500);
                    
                    // E-CPR popup if arrest >5 minutes
                    setTimeout(function() {
                        if (totalSeconds >= 420 && !ecprPromptDismissed) {
                            $('ecprModal').classList.remove('hidden');
                        }
                    }, 1000);
                }, 300);
            }
        }
        
        // Landing screen handlers
        $('btnNewCode').addEventListener('click', startFreshArrest);
        
        $('btnCodeInProgress').addEventListener('click', function() {
            // Populate hour and minute selects
            var hoursEl = $('setupHours');
            var minsEl = $('setupMinutes');
            
            // Clear and populate
            hoursEl.innerHTML = '';
            minsEl.innerHTML = '';
            
            for (var h = 0; h < 24; h++) {
                var opt = document.createElement('option');
                opt.value = h;
                opt.textContent = (h < 10 ? '0' : '') + h;
                hoursEl.appendChild(opt);
            }
            
            for (var m = 0; m < 60; m++) {
                var opt = document.createElement('option');
                opt.value = m;
                opt.textContent = (m < 10 ? '0' : '') + m;
                minsEl.appendChild(opt);
            }
            
            // Set default time to current time
            var now = new Date();
            hoursEl.value = now.getHours();
            minsEl.value = now.getMinutes();
            
            $('setupModal').classList.remove('hidden');
        });
        
        // Setup modal state
        var setupState = {
            timeMins: null,
            customTime: null,
            shocks: null,
            shocksExact: null,
            rhythm: null,
            amio: null,
            adrenaline: null
        };
        
        function updateSetupValidation(showMessage) {
            var valid = true;
            var msg = '';
            
            if (setupState.timeMins === null && setupState.customTime === null) {
                valid = false;
                msg = 'Select time since collapse';
            } else if (setupState.shocks === null) {
                valid = false;
                msg = 'Select number of shocks';
            } else if (setupState.shocks === '3+' && setupState.shocksExact === null) {
                valid = false;
                msg = 'Select exact shock count';
            } else if (setupState.shocks === '0' && setupState.rhythm === null) {
                valid = false;
                msg = 'Select initial rhythm';
            } else if ((setupState.shocksExact !== null && parseInt(setupState.shocksExact, 10) >= 3) || 
                       (setupState.shocks !== null && setupState.shocks !== '0' && setupState.shocks !== '3+' && parseInt(setupState.shocks, 10) >= 3)) {
                // This shouldn't happen with current UI, but handle it
            } else if (setupState.shocks === '3+' && setupState.amio === null) {
                valid = false;
                msg = 'Select if amiodarone given';
            } else if (setupState.adrenaline === null) {
                valid = false;
                msg = 'Select adrenaline status';
            }
            
            // Check if amio section should require answer
            var effectiveShocks = setupState.shocks === '3+' ? 
                (setupState.shocksExact ? parseInt(setupState.shocksExact, 10) : 3) : 
                parseInt(setupState.shocks, 10);
            if (effectiveShocks >= 3 && setupState.amio === null) {
                valid = false;
                msg = 'Select if amiodarone given';
            }
            
            // Only show message if explicitly requested (e.g., on START click)
            $('setupValidation').textContent = showMessage ? msg : '';
            if (valid) {
                $('btnStartSetup').classList.add('ready');
            } else {
                $('btnStartSetup').classList.remove('ready');
            }
            return valid;
        }
        
        // Setup time buttons
        $('setupTimeGroup').addEventListener('click', function(e) {
            if (e.target.classList.contains('setup-btn')) {
                $('setupTimeGroup').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
                e.target.classList.add('selected');
                var mins = e.target.getAttribute('data-mins');
                if (mins === 'custom') {
                    $('customTimeSection').classList.add('visible');
                    setupState.timeMins = null;
                    setupState.customTime = $('setupHours').value + ':' + $('setupMinutes').value;
                } else {
                    $('customTimeSection').classList.remove('visible');
                    setupState.timeMins = parseInt(mins, 10);
                    setupState.customTime = null;
                }
                updateSetupValidation();
            }
        });
        
        function updateCustomTime() {
            setupState.customTime = $('setupHours').value + ':' + $('setupMinutes').value;
            updateSetupValidation();
        }
        $('setupHours').addEventListener('change', updateCustomTime);
        $('setupMinutes').addEventListener('change', updateCustomTime);
        
        // Setup shocks buttons
        $('setupShocksGroup').addEventListener('click', function(e) {
            if (e.target.classList.contains('setup-btn')) {
                $('setupShocksGroup').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
                var shocks = e.target.getAttribute('data-shocks');
                setupState.shocks = shocks;
                setupState.shocksExact = null;
                $('shocksExactSection').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
                
                if (shocks === '3+') {
                    // Don't highlight 3+ - user must select from sub-options
                    $('shocksExactSection').classList.add('visible');
                    $('setupAmioSection').classList.remove('hidden');
                } else {
                    e.target.classList.add('selected');
                    $('shocksExactSection').classList.remove('visible');
                    if (parseInt(shocks, 10) >= 3) {
                        $('setupAmioSection').classList.remove('hidden');
                    } else {
                        $('setupAmioSection').classList.add('hidden');
                        setupState.amio = null;
                    }
                }
                
                if (shocks === '0') {
                    $('setupRhythmSection').classList.remove('hidden');
                } else {
                    $('setupRhythmSection').classList.add('hidden');
                    setupState.rhythm = null;
                }
                
                updateSetupValidation();
            }
        });
        
        // Setup exact shocks buttons
        $('shocksExactSection').addEventListener('click', function(e) {
            if (e.target.classList.contains('setup-btn')) {
                $('shocksExactSection').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
                e.target.classList.add('selected');
                setupState.shocksExact = e.target.getAttribute('data-shocks-exact');
                updateSetupValidation();
            }
        });
        
        // Setup rhythm buttons
        $('setupRhythmGroup').addEventListener('click', function(e) {
            if (e.target.classList.contains('setup-btn')) {
                $('setupRhythmGroup').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
                e.target.classList.add('selected');
                setupState.rhythm = e.target.getAttribute('data-rhythm');
                updateSetupValidation();
            }
        });
        
        // Setup amio buttons
        $('setupAmioGroup').addEventListener('click', function(e) {
            if (e.target.classList.contains('setup-btn')) {
                $('setupAmioGroup').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
                e.target.classList.add('selected');
                setupState.amio = e.target.getAttribute('data-amio');
                updateSetupValidation();
            }
        });
        
        // Setup adrenaline buttons
        $('setupAdrenalineGroup').addEventListener('click', function(e) {
            if (e.target.classList.contains('setup-btn')) {
                $('setupAdrenalineGroup').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
                e.target.classList.add('selected');
                setupState.adrenaline = e.target.getAttribute('data-adr');
                updateSetupValidation();
            }
        });
        
        // Cancel setup
        $('btnCancelSetup').addEventListener('click', function() {
            $('setupModal').classList.add('hidden');
            // Reset state
            setupState = { timeMins: null, customTime: null, shocks: null, shocksExact: null, rhythm: null, amio: null, adrenaline: null };
            $('setupTimeGroup').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
            $('setupShocksGroup').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
            $('shocksExactSection').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
            $('setupRhythmGroup').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
            $('setupAmioGroup').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
            $('setupAdrenalineGroup').querySelectorAll('.setup-btn').forEach(function(b) { b.classList.remove('selected'); });
            $('customTimeSection').classList.remove('visible');
            $('shocksExactSection').classList.remove('visible');
            $('setupRhythmSection').classList.add('hidden');
            $('setupAmioSection').classList.add('hidden');
            $('btnStartSetup').classList.remove('ready');
            $('setupValidation').textContent = '';
        });
        
        // Start tracking from setup
        $('btnStartSetup').addEventListener('click', function() {
            if (!updateSetupValidation(true)) return;
            
            // Calculate arrest time
            var arrestTime;
            if (setupState.timeMins !== null) {
                arrestTime = new Date();
                arrestTime.setMinutes(arrestTime.getMinutes() - setupState.timeMins);
            } else {
                arrestTime = new Date();
                var parts = setupState.customTime.split(':');
                arrestTime.setHours(parseInt(parts[0], 10) || 0);
                arrestTime.setMinutes(parseInt(parts[1], 10) || 0);
                // If time is in future, assume yesterday
                if (arrestTime > new Date()) {
                    arrestTime.setDate(arrestTime.getDate() - 1);
                }
            }
            
            // Calculate effective shocks
            var effectiveShocks;
            if (setupState.shocks === '3+') {
                effectiveShocks = setupState.shocksExact === '6+' ? 6 : parseInt(setupState.shocksExact, 10);
            } else {
                effectiveShocks = parseInt(setupState.shocks, 10);
            }
            
            // Determine if shockable
            var isShockable;
            var rhythmNotChecked = false;
            if (effectiveShocks > 0) {
                isShockable = true;
            } else if (setupState.rhythm === 'shockable') {
                isShockable = true;
            } else if (setupState.rhythm === 'nonshockable') {
                isShockable = false;
            } else {
                // Not yet checked
                isShockable = null;
                rhythmNotChecked = true;
            }
            
            // Adrenaline state
            var adrenalineState = setupState.adrenaline;
            var adrenalineCount = (adrenalineState === 'given' || adrenalineState === 'due') ? 1 : 0;
            
            // Build setup data
            var data = {
                arrestTime: arrestTime,
                shocks: effectiveShocks,
                isShockable: isShockable,
                rhythmNotChecked: rhythmNotChecked,
                amiodaroneGiven: setupState.amio === 'yes',
                adrenalineState: adrenalineState,
                adrenalineCount: adrenalineCount
            };
            
            $('setupModal').classList.add('hidden');
            startMidArrest(data);
        });
        
        
        // Update arrest time - click header to update
        $('headerLeft').addEventListener('click', function() {
            if (!arrestStartTime) return;
            var hours = (arrestStartTime.getHours() < 10 ? '0' : '') + arrestStartTime.getHours();
            var mins = (arrestStartTime.getMinutes() < 10 ? '0' : '') + arrestStartTime.getMinutes();
            $('updateTime').value = hours + ':' + mins;
            $('updateTimeModal').classList.remove('hidden');
        });
        
        $('btnCancelUpdate').addEventListener('click', function() {
            $('updateTimeModal').classList.add('hidden');
        });
        
        $('btnConfirmUpdate').addEventListener('click', function() {
            var now = new Date();
            var newStartTime = new Date();
            var timeVal = $('updateTime').value;
            if (timeVal) {
                var parts = timeVal.split(':');
                newStartTime.setHours(parseInt(parts[0], 10) || 0);
                newStartTime.setMinutes(parseInt(parts[1], 10) || 0);
            }
            newStartTime.setSeconds(0);
            if (newStartTime > now) newStartTime.setDate(newStartTime.getDate() - 1);
            
            var oldMins = Math.floor(totalSeconds / 60);
            arrestStartTime = newStartTime;
            totalSeconds = Math.floor((now - newStartTime) / 1000);
            var newMins = Math.floor(totalSeconds / 60);
            
            addLog('Arrest time updated: ' + oldMins + '  ' + newMins + ' min');
            $('updateTimeModal').classList.add('hidden');
            updateDisplay();
        });
        
        // DEVELOPER NOTE: Timer drift consideration
        // setInterval can drift on busy devices. For sub-second accuracy, consider computing
        // elapsed time from timestamps each tick instead of incrementing counters:
        //   totalSeconds = Math.floor((Date.now() - arrestStartTime) / 1000);
        //   cprSeconds = CPR_INTERVAL - Math.floor((Date.now() - lastRhythmCheckTime) / 1000);
        //   adrenalineSeconds = ADRENALINE_INTERVAL - Math.floor((Date.now() - lastAdrenalineTime) / 1000);
        // For typical 30-60 min resuscitations, drift is likely <5 seconds, which is clinically acceptable.
        
        function tick() {
            totalSeconds++;
            if (!roscActive) {
                // Only countdown CPR if rhythm check has started
                if (rhythmCheckStarted) {
                    cprSeconds--;
                    if (cprSeconds === 0) {
                        vibrate([200, 100, 200, 100, 200]);
                        playAlert('rhythm');
                    }
                    if (cprSeconds < 0 && cprSeconds % 10 === 0) vibrate([50, 50, 50]);
                }
                if (adrenalineStarted) {
                    adrenalineSeconds--;
                    if (adrenalineSeconds === 0) {
                        vibrate([300, 100, 300]);
                        playAlert('adrenaline');
                    }
                }
            }
            
            if (ecprRemindTime && totalSeconds >= ecprRemindTime) {
                $('ecprModal').classList.remove('hidden');
                ecprRemindTime = null;
            }
            
            // E-CPR prompt at 7 minutes if not already shown
            if (totalSeconds === 420 && !ecprPromptDismissed) {
                $('ecprModal').classList.remove('hidden');
            }
            
            updateDisplay();
            
            // Update summary every 10 seconds
            if (totalSeconds % 10 === 0) updateLogSummary();
        }
        
        function updateDisplay() {
            $('totalTime').textContent = resusStarted ? formatTimeHMS(totalSeconds) : '--:--';
            
            var cprBox = $('rhythmCheckBox');
            var cprTimeEl = $('cprTime');
            var cprHint = $('cprHint');
            
            if (resusStarted) {
                if (roscActive) {
                    cprTimeEl.textContent = 'ROSC';
                    cprTimeEl.classList.remove('hidden');
                    cprTimeEl.style.color = '#44ff44';
                    cprBox.style.borderColor = '#44ff44';
                    cprBox.classList.remove('expired');
                    cprHint.textContent = '';
                } else if (!rhythmCheckStarted) {
                    // Hide timer, just show buttons
                    cprTimeEl.classList.add('hidden');
                    cprBox.style.borderColor = '#666';
                    cprBox.classList.remove('expired');
                    cprHint.textContent = '';
                } else {
                    var color = getTimerColor(cprSeconds);
                    cprTimeEl.textContent = formatTime(cprSeconds);
                    cprTimeEl.classList.remove('hidden');
                    cprTimeEl.style.color = color;
                    cprBox.style.borderColor = color;
                    cprBox.classList.toggle('expired', cprSeconds <= 0);
                    cprHint.textContent = cprSeconds <= 0 ? 'OVERDUE' : '';
                }
                
                // Update label based on state
                $('rhythmCheckLabel').textContent = rhythmCheckStarted ? 'NEXT RHYTHM CHECK DUE' : 'Rhythm Check';
            }
            
            var adrBox = $('adrenalineTimer');
            var adrTimeEl = $('adrenalineTime');
            var adrHint = $('adrHint');
            var adrNote = $('adrNote');
            
            if (roscActive) {
                adrTimeEl.textContent = '';
                adrTimeEl.style.color = '#666';
                adrBox.style.borderColor = '#666';
                adrBox.classList.remove('expired');
                adrHint.textContent = '';
                adrNote.style.display = 'none';
            } else if (adrenalineStarted) {
                var adrColor = getAdrenalineColor(adrenalineSeconds);
                adrTimeEl.textContent = formatTime(adrenalineSeconds);
                adrTimeEl.style.color = adrColor;
                adrBox.style.borderColor = adrColor;
                adrBox.classList.toggle('expired', adrenalineSeconds <= 0);
                adrHint.textContent = adrenalineSeconds <= 0 ? 'OVERDUE' : '';
                adrNote.style.display = 'block';
                adrNote.textContent = 'Tap when given';
                $('adrenalineLabel').textContent = 'NEXT ADRENALINE';
            } else {
                adrTimeEl.textContent = 'TAP';
                adrTimeEl.style.color = '#666';
                adrBox.style.borderColor = '#666';
                adrHint.textContent = '';
                adrNote.style.display = 'block';
                adrNote.textContent = 'Tap when given';
                $('adrenalineLabel').textContent = 'Adrenaline';
            }
            
            // Shock counter display
            if (shockCount > 0) {
                $('shockCount').textContent = shockCount;
                $('shockHint').textContent = 'Tap +1   Hold -1';
            } else {
                $('shockCount').textContent = 'TAP';
                $('shockHint').textContent = 'Tap when given';
            }
            
            // ROSC button and display
            var roscBtn = $('btnRosc');
            var roscHistoryBtn = $('btnRoscHistory');
            var headerTapHint = $('headerTapHint');
            
            // Show tap to update hint once resuscitation has started
            if (resusStarted) {
                headerTapHint.classList.remove('hidden');
            } else {
                headerTapHint.classList.add('hidden');
            }
            
            if (resusStarted && rhythmCheckStarted) {
                roscBtn.classList.remove('hidden');
                if (roscActive) {
                    roscBtn.textContent = ' Re-arrest';
                    roscBtn.classList.add('rearrest');
                    $('roscDisplay').textContent = 'ROSC at ' + roscTimeStr;
                    roscHistoryBtn.classList.add('hidden');
                } else {
                    roscBtn.textContent = 'ROSC';
                    roscBtn.classList.remove('rearrest');
                    $('roscDisplay').textContent = '';
                    // Show ROSC history button if there's history
                    if (roscHistory.length > 0) {
                        roscHistoryBtn.classList.remove('hidden');
                    } else {
                        roscHistoryBtn.classList.add('hidden');
                    }
                }
            } else {
                roscBtn.classList.add('hidden');
                roscHistoryBtn.classList.add('hidden');
            }
            
            // Auto-sync wizard duration selects when checkbox is checked
            if (resusStarted) {
                var mins = Math.floor(totalSeconds / 60);
                if ($('ihcaAutoSyncWizard') && $('ihcaAutoSyncWizard').checked) {
                    $('ihcaMinsWizard').value = Math.min(Math.max(mins, 1), 60);
                }
                if ($('oohcaAutoSyncWizard') && $('oohcaAutoSyncWizard').checked) {
                    var options = [5, 10, 15, 20, 30, 40, 47];
                    var closest = options.reduce(function(prev, curr) {
                        return Math.abs(curr - mins) < Math.abs(prev - mins) ? curr : prev;
                    });
                    $('oohcaMinsWizard').value = closest;
                }
            }
            
            // Header alert when not on timer tab and timers are due
            var headerAlert = $('headerAlert');
            var onTimerTab = $('tab-timer').classList.contains('active');
            var alerts = [];
            
            if (!roscActive && resusStarted) {
                if (rhythmCheckStarted && cprSeconds <= 10) {
                    alerts.push('Rhythm check ' + (cprSeconds <= 0 ? 'OVERDUE' : 'due'));
                }
                if (adrenalineStarted && adrenalineSeconds <= 10) {
                    alerts.push('Adrenaline ' + (adrenalineSeconds <= 0 ? 'OVERDUE' : 'due'));
                }
            }
            
            if (!onTimerTab && alerts.length > 0) {
                headerAlert.textContent = alerts.join('  ');
                headerAlert.classList.add('show');
            } else {
                headerAlert.classList.remove('show');
            }
        }
        
        // VF/VT button - prompts for shock confirmation
        $('btnVfVt').addEventListener('click', function() {
            if (!resusStarted || roscActive) return;
            $('shockConfirmModal').classList.remove('hidden');
        });
        
        // Shock confirmation modal handlers
        $('shockYes').addEventListener('click', function() {
            shockCount++;
            rhythmCheckCount++;
            rhythmCheckStarted = true;
            $('shockCounter').classList.remove('hidden');
            revealFullUI();
            cprSeconds = 120;
            vibrate(50);
            addLog('Rhythm check #' + rhythmCheckCount + ' (VF/VT)  Shock #' + shockCount);
            $('shockConfirmModal').classList.add('hidden');
            
            // Adrenaline prompt after 2nd shock if not already given
            if (shockCount === 2 && adrenalineCount === 0) {
                $('adrReminderTitle').textContent = 'Adrenaline';
                $('adrReminderContext').textContent = '2nd shock delivered';
                $('adrenalineReminderModal').classList.remove('hidden');
                // E-CPR modal will show after adrenaline response (handled in adrReminderYes/Omit)
            } else if (rhythmCheckCount === 3 && !ecprPromptDismissed) {
                // Only show E-CPR if we didn't show adrenaline modal
                $('ecprModal').classList.remove('hidden');
            }
            
            // Amiodarone prompts
            if (shockCount === 3 && !amiodaroneGiven) {
                $('amioTitle').textContent = '3rd Shock';
                $('amioDose').textContent = 'Amiodarone 300mg IV';
                $('amioModal').classList.remove('hidden');
            }
            if (shockCount === 5 && !amiodaroneGiven) {
                $('amioTitle').textContent = '5th Shock';
                $('amioDose').textContent = 'Amiodarone 150mg IV';
                $('amioModal').classList.remove('hidden');
            }
            
            updateDisplay();
        });
        
        $('shockNo').addEventListener('click', function() {
            rhythmCheckCount++;
            rhythmCheckStarted = true;
            $('shockCounter').classList.remove('hidden');
            revealFullUI();
            cprSeconds = 120;
            vibrate(50);
            addLog('Rhythm check #' + rhythmCheckCount + ' (VF/VT)  No shock');
            $('shockConfirmModal').classList.add('hidden');
            if (rhythmCheckCount === 3 && !ecprPromptDismissed) {
                $('ecprModal').classList.remove('hidden');
            }
            updateDisplay();
        });
        
        // PEA/Asystole button
        $('btnPea').addEventListener('click', function() {
            if (!resusStarted || roscActive) return;
            rhythmCheckCount++;
            rhythmCheckStarted = true;
            revealFullUI();
            cprSeconds = 120;
            vibrate(50);
            addLog('Rhythm check #' + rhythmCheckCount + ' (PEA/Asystole)');
            
            // Reminder about adrenaline if not already given
            if (!adrenalineStarted) {
                $('adrReminderTitle').textContent = 'Adrenaline';
                $('adrReminderContext').textContent = 'Non-shockable rhythm';
                $('adrenalineReminderModal').classList.remove('hidden');
            } else if (rhythmCheckCount === 3 && !ecprPromptDismissed) {
                $('ecprModal').classList.remove('hidden');
            }
            updateDisplay();
        });
        
        $('adrReminderYes').addEventListener('click', function() {
            // Record adrenaline given
            adrenalineCount++;
            adrenalineStarted = true;
            adrenalineSeconds = 240;
            vibrate(50);
            addLog('Adrenaline #' + adrenalineCount + ' given');
            $('adrenalineReminderModal').classList.add('hidden');
            if (rhythmCheckCount === 3 && !ecprPromptDismissed) {
                $('ecprModal').classList.remove('hidden');
            }
            updateDisplay();
        });
        
        $('adrReminderOmit').addEventListener('click', function() {
            $('adrenalineReminderModal').classList.add('hidden');
            if (rhythmCheckCount === 3 && !ecprPromptDismissed) {
                $('ecprModal').classList.remove('hidden');
            }
        });
        
        // Adrenaline Timer tap
        $('adrenalineTimer').addEventListener('click', function() {
            if (!resusStarted || roscActive) return;
            adrenalineCount++;
            adrenalineStarted = true;
            adrenalineSeconds = 240;
            vibrate(50);
            addLog('Adrenaline #' + adrenalineCount + ' given');
            updateDisplay();
        });
        
        // Shock counter
        var shockPressTimer = null;
        var shockHandled = false;
        
        $('shockCounter').addEventListener('mousedown', handleShockDown);
        $('shockCounter').addEventListener('mouseup', handleShockUp);
        $('shockCounter').addEventListener('touchstart', handleShockDown, { passive: false });
        $('shockCounter').addEventListener('touchend', handleShockUp, { passive: false });
        
        function handleShockDown(e) {
            e.preventDefault();
            shockHandled = false;
            shockPressTimer = setTimeout(function() {
                if (shockCount > 0) {
                    shockCount--;
                    vibrate([50, 50, 50]);
                    addLog('Shock removed (now ' + shockCount + ')');
                    updateDisplay();
                }
                shockHandled = true;
            }, 800);
        }
        
        function handleShockUp(e) {
            e.preventDefault();
            if (shockPressTimer) { clearTimeout(shockPressTimer); shockPressTimer = null; }
            if (!shockHandled) {
                shockCount++;
                vibrate(50);
                addLog('Shock #' + shockCount);
                if (shockCount === 3 && !amiodaroneGiven) {
                    $('amioTitle').textContent = '3rd Shock';
                    $('amioDose').textContent = 'Amiodarone 300mg IV';
                    $('amioModal').classList.remove('hidden');
                }
                if (shockCount === 5 && !amiodaroneGiven) {
                    $('amioTitle').textContent = '5th Shock';
                    $('amioDose').textContent = 'Amiodarone 150mg IV';
                    $('amioModal').classList.remove('hidden');
                }
                updateDisplay();
            }
        }
        
        // Modals
        $('ecprYes').addEventListener('click', function() {
            $('ecprModal').classList.add('hidden');
            addLog('E-CPR: Yes - calling for ECMO');
            ecprPromptDismissed = true;
        });
        
        $('ecprAssess').addEventListener('click', function() {
            $('ecprModal').classList.add('hidden');
            // Switch to E-CPR tab
            document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            document.querySelector('[data-tab="ecpr"]').classList.add('active');
            $('tab-ecpr').classList.add('active');
            addLog('E-CPR: Assessing suitability');
        });
        
        $('ecprRemind').addEventListener('click', function() {
            $('ecprModal').classList.add('hidden');
            ecprRemindTime = totalSeconds + 300;
            addLog('E-CPR: Remind in 5 min');
        });
        
        $('ecprNo').addEventListener('click', function() {
            $('ecprModal').classList.add('hidden');
            addLog('E-CPR: Not appropriate/available');
            ecprPromptDismissed = true;
        });
        
        $('amioGiven').addEventListener('click', function() { 
            $('amioModal').classList.add('hidden');
            amiodaroneGiven = true;
            addLog('Amiodarone given');
            // Show E-CPR if this was rhythm check #2 and not yet dismissed
            if (rhythmCheckCount === 3 && !ecprPromptDismissed) {
                $('ecprModal').classList.remove('hidden');
            }
        });
        
        $('amioOmitted').addEventListener('click', function() { 
            $('amioModal').classList.add('hidden');
            amiodaroneGiven = true; // Mark as handled so it doesn't prompt again
            addLog('Amiodarone omitted');
            // Show E-CPR if this was rhythm check #2 and not yet dismissed
            if (rhythmCheckCount === 3 && !ecprPromptDismissed) {
                $('ecprModal').classList.remove('hidden');
            }
        });
        
        // ROSC / Re-arrest button
        $('btnRosc').addEventListener('click', function() {
            if (!resusStarted) return;
            
            if (!roscActive) {
                // ROSC achieved
                roscActive = true;
                roscStartTime = new Date();
                var now = roscStartTime;
                roscTimeStr = now.toTimeString().slice(0, 5);
                addLog('ROSC achieved');
                vibrate([100, 50, 100, 50, 100]);
            } else {
                // Re-arrest - save ROSC period to history
                var endTime = new Date();
                var durationSecs = Math.floor((endTime - roscStartTime) / 1000);
                var durationMins = Math.floor(durationSecs / 60);
                var durationStr = durationMins + ' min' + (durationSecs % 60 > 0 ? ' ' + (durationSecs % 60) + ' sec' : '');
                roscHistory.push({
                    start: roscTimeStr,
                    end: endTime.toTimeString().slice(0, 5),
                    duration: durationStr,
                    durationMins: durationMins
                });
                roscActive = false;
                rhythmCheckStarted = false;
                cprSeconds = 120;
                adrenalineSeconds = 240;
                adrenalineStarted = false;
                addLog('Re-arrest (ROSC duration: ' + durationStr + ')');
                vibrate([200, 100, 200]);
            }
            updateDisplay();
        });
        
        // ROSC history button
        $('btnRoscHistory').addEventListener('click', function() {
            var content = '';
            if (roscHistory.length === 0) {
                content = '<p style="color: #888; text-align: center;">No previous ROSC periods recorded</p>';
            } else {
                roscHistory.forEach(function(period, i) {
                    content += '<div class="rosc-history-item">';
                    content += '<div class="duration">' + period.duration + ' of ROSC</div>';
                    content += '<div class="times">' + period.start + '  ' + period.end + '</div>';
                    content += '</div>';
                });
            }
            $('roscHistoryContent').innerHTML = content;
            $('roscHistoryModal').classList.remove('hidden');
        });
        
        $('roscHistoryClose').addEventListener('click', function() {
            $('roscHistoryModal').classList.add('hidden');
        });
        
        // Termination button
        $('btnTerminate').addEventListener('click', function() {
            if (!resusStarted) return;
            
            var now = new Date();
            var endTimeStr = now.toTimeString().slice(0, 5);
            var totalMins = Math.floor(totalSeconds / 60);
            var totalSecs = totalSeconds % 60;
            var durationStr = totalMins + ':' + (totalSecs < 10 ? '0' : '') + totalSecs;
            
            addLog('Resuscitation terminated at ' + endTimeStr + ' (duration: ' + durationStr + ')');
            
            // Stop timers
            resusStarted = false;
            rhythmCheckStarted = false;
            adrenalineStarted = false;
            roscActive = false;
            
            // Change button to indicate termination
            $('btnTerminate').textContent = 'Resuscitation Terminated';
            $('btnTerminate').style.borderColor = '#ff6b6b';
            $('btnTerminate').style.color = '#ff6b6b';
            $('btnTerminate').disabled = true;
            
            // Hide ROSC button since resuscitation is over
            $('btnRosc').classList.add('hidden');
            
            vibrate([500]);
            updateDisplay();
        });
        
        // Hs & Ts
        var actionItems = [
            { id: 'airway', label: 'Airway confirmed with EtCO and delivering 100% O' },
            { id: 'fluid', label: 'Fluid bolus' },
            { id: 'gas', label: 'Blood gas for pH, K, BSL and Hb' },
            { id: 'toxins', label: 'Check chart for toxins' },
            { id: 'pneumo', label: 'Check if trachea midline or difficult to ventilate (?tension pneumothorax)', arrow: ' Finger thoracostomy' },
            { id: 'echo', label: 'Echo to check for tamponade' },
            { id: 'haem', label: 'Consider haemorrhage', arrow: ' reverse anticoag, activate MTP' },
            { id: 'ami', label: 'Consider AMI' },
            { id: 'pe', label: 'Consider PE', arrow: ' thrombolyse' },
            { id: 'artline', label: 'Consider art line', arrow: ' dose adrenaline to dBP >35' },
            { id: 'mechcpr', label: 'Consider mechanical CPR' },
            { id: 'family', label: 'Home team and family called' }
        ];
        
        function renderHTs() {
            var actionsHTML = '';
            // Sort: unchecked items first, checked items at bottom
            var sortedItems = actionItems.slice().sort(function(a, b) {
                var aChecked = htChecked[a.id] ? 1 : 0;
                var bChecked = htChecked[b.id] ? 1 : 0;
                return aChecked - bChecked;
            });
            sortedItems.forEach(function(item) {
                var checked = htChecked[item.id] ? ' checked' : '';
                var arrow = item.arrow ? '<span class="check-arrow">' + item.arrow + '</span>' : '';
                actionsHTML += '<div class="check-item' + checked + '" data-id="' + item.id + '"><div class="check-box">' + (htChecked[item.id] ? '' : '') + '</div><div class="check-label">' + item.label + arrow + '</div></div>';
            });
            $('actionsList').innerHTML = actionsHTML;
        }
        
        // Event delegation for checklist
        $('actionsList').addEventListener('click', function(e) {
            var item = e.target.closest('.check-item');
            if (item) {
                var id = item.getAttribute('data-id');
                htChecked[id] = !htChecked[id];
                if (htChecked[id]) addLog('Checked: ' + id);
                renderHTs();
            }
        });
        renderHTs();
        
        // Drugs
        // Drug categories for clear mental model
        var coreDrugs = [
            { name: 'Adrenaline 1mg/10mL', indication: 'Immediately for non-shockable, after 2nd shock for shockable', dose: '10mL IV q3-5min' },
            { name: 'Amiodarone 150mg/3mL', indication: 'Refractory VF/VT', dose: '2 amps + 14mL G5% = 20mL. Give 20mL after 3rd shock, 10mL after 5th' },
            { name: 'Lignocaine 1% 100mg/10mL', indication: 'Alternative to Amiodarone for refractory VF/VT', dose: '10mL IV bolus' },
            { name: 'Magnesium sulfate 49.3% 10mmol/5mL', indication: 'Torsades de pointes, hypomagnesaemia', dose: '5mL IV over 1-2 min' }
        ];
        
        var electrolyteDrugs = [
            { name: 'Calcium gluconate 10% 10mL', indication: 'Hyperkalaemia, hypocalcaemia, CCB OD, hypermagnesaemia', dose: '30mL (3 amps) IV' },
            { name: 'Sodium bicarbonate 8.4% 50mL', indication: 'Hyperkalaemia, TCA OD, severe acidosis', dose: '50-100mL IV' },
            { name: 'Insulin (Actrapid) + Glucose 50%', indication: 'Hyperkalaemia', dose: '10 units + 50mL glucose IV' },
            { name: 'Potassium chloride 10mmol/10mL', indication: 'Hypokalaemia (K <2.5)', dose: '20mL via CVC over 10 min' }
        ];
        
        var causesDrugs = [
            { name: 'Alteplase 50mg vial', indication: 'Massive PE. Continue CPR 60-90 min post-lysis', dose: '50mg IV bolus, repeat at 15 min' }
        ];
        
        var toxidromeDrugs = [
            { name: 'Intralipid 20%', indication: 'Local anaesthetic toxicity', dose: '1.5mL/kg bolus  15mL/kg/hr. Repeat bolus x2 q5min. Max 12mL/kg' },
            { name: 'Sodium bicarbonate 8.4%', indication: 'TCA toxicity (QRS >100ms)', dose: '100mL IV bolus' },
            { name: 'Hydroxocobalamin 5g vial', indication: 'Cyanide (smoke inhalation, nitroprusside)', dose: '5g IV over 15 min, repeat to max 15g' },
            { name: 'Digoxin immune Fab (DigiFab)', indication: 'Digoxin toxicity', dose: 'Per toxicology advice' },
            { name: 'Atropine 1.2mg/1.5mL', indication: 'Organophosphate / nerve agent poisoning', dose: '1.2-3mg IV, repeat q5min PRN' },
            { name: 'Glucagon 1mg vial', indication: 'Beta-blocker / CCB toxicity', dose: '5-10mg IV bolus (5-10 vials)' }
        ];
        
        function renderDrug(d) {
            var indicationHTML = d.indication ? '<div class="drug-indication">' + d.indication + '</div>' : '';
            return '<div class="drug-item"><div class="drug-left"><div class="drug-name">' + d.name + '</div>' + indicationHTML + '</div><div class="drug-dose">' + d.dose + '</div></div>';
        }
        
        $('coreDrugsList').innerHTML = coreDrugs.map(renderDrug).join('');
        $('electrolyteSection').innerHTML = electrolyteDrugs.map(renderDrug).join('');
        $('causesSection').innerHTML = causesDrugs.map(renderDrug).join('');
        $('toxidromeSection').innerHTML = toxidromeDrugs.map(renderDrug).join('');
        
        // Drug section toggles
        document.querySelectorAll('.drug-section-toggle').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var sectionId = btn.getAttribute('data-section');
                var section = $(sectionId);
                var isOpen = section.classList.contains('show');
                
                // Close all sections first
                document.querySelectorAll('.drug-section').forEach(function(s) { s.classList.remove('show'); });
                document.querySelectorAll('.drug-section-toggle').forEach(function(b) { 
                    b.textContent = ' ' + b.textContent.substring(2);
                });
                
                // Open this one if it was closed
                if (!isOpen) {
                    section.classList.add('show');
                    btn.textContent = ' ' + btn.textContent.substring(2);
                }
            });
        });
        
        // Old prognosis code removed - using wizard UI

        
        // E-CPR Wizard
        var ecprWizardData = { age: null, withinTime: null, witnessed: null, shockable: null, bystander: null, noEndStage: null };
        var ecprCurrentStep = 1;
        
        // Populate age select
        (function() {
            var ageSelect = $('ecprAgeWizard');
            for (var i = 18; i <= 100; i++) {
                var opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                ageSelect.appendChild(opt);
            }
        })();
        
        function ecprShowStep(step) {
            ecprCurrentStep = step;
            document.querySelectorAll('#ecprWizard .wizard-step').forEach(function(s) {
                s.classList.remove('active');
            });
            document.querySelector('#ecprWizard .wizard-step[data-step="' + step + '"]').classList.add('active');
            
            // Update progress dots
            var dots = document.querySelectorAll('#ecprProgress .wizard-progress-dot');
            var stepNum = typeof step === 'number' ? step : 7;
            dots.forEach(function(dot, i) {
                dot.classList.remove('complete', 'current');
                if (i < stepNum - 1) dot.classList.add('complete');
                if (i === stepNum - 1) dot.classList.add('current');
            });
        }
        
        $('ecprAgeWizard').addEventListener('change', function() {
            var age = parseInt(this.value, 10);
            ecprWizardData.age = age;
            $('ecprNext1').disabled = false;
            var maxTime = 100 - age;
            $('ecprTimeQuestion').textContent = 'Can ECMO decision be made within ' + maxTime + ' min?';
            $('ecprAgeWizardWarning').textContent = age > 65 ? ' Age >65 favours exclusion' : '';
        });
        
        $('ecprNext1').addEventListener('click', function() {
            ecprShowStep(2);
        });
        
        // ECPR wizard option clicks
        document.querySelectorAll('#ecprWizard .wizard-option[data-field]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var field = btn.getAttribute('data-field');
                var value = btn.getAttribute('data-value') === 'yes';
                ecprWizardData[field] = value;
                
                // Move to next step
                var currentStep = btn.closest('.wizard-step').getAttribute('data-step');
                var nextStep = parseInt(currentStep, 10) + 1;
                if (nextStep <= 6) {
                    ecprShowStep(nextStep);
                } else {
                    // Calculate result
                    ecprCalculateResult();
                    ecprShowStep(7);
                }
            });
        });
        
        function ecprCalculateResult() {
            var metCount = 0;
            var notMetCount = 0;
            ['withinTime', 'witnessed', 'shockable', 'bystander', 'noEndStage'].forEach(function(key) {
                if (ecprWizardData[key] === true) metCount++;
                if (ecprWizardData[key] === false) notMetCount++;
            });
            
            var resultEl = $('ecprWizardResult');
            var criteriaEl = $('ecprWizardCriteria');
            resultEl.classList.remove('good', 'medium', 'bad');
            
            if (metCount === 5) {
                resultEl.textContent = '~46%';
                resultEl.classList.add('good');
                criteriaEl.textContent = 'All 5 criteria met';
            } else if (notMetCount === 1) {
                resultEl.textContent = '~12%';
                resultEl.classList.add('medium');
                criteriaEl.textContent = '4 of 5 criteria met';
            } else {
                resultEl.textContent = 'No survivors';
                resultEl.classList.add('bad');
                criteriaEl.textContent = notMetCount + ' criteria not met';
            }
        }
        
        function ecprBack(fromStep) {
            var prevStep = fromStep === 7 ? 6 : (typeof fromStep === 'number' ? fromStep - 1 : 1);
            ecprShowStep(prevStep);
        }
        window.ecprBack = ecprBack;
        
        function ecprReset() {
            ecprWizardData = { age: null, withinTime: null, witnessed: null, shockable: null, bystander: null, noEndStage: null };
            $('ecprAgeWizard').value = '';
            $('ecprNext1').disabled = true;
            $('ecprAgeWizardWarning').textContent = '';
            document.querySelectorAll('#ecprWizard .wizard-option').forEach(function(o) { o.classList.remove('selected'); });
            ecprShowStep(1);
        }
        window.ecprReset = ecprReset;
        
        // Prognosis Wizard
        var progWizardData = { type: null, age: null, witnessed: null, rhythm: null, duration: 1, oohcaRhythm: null, oohcaWitnessed: null, oohcaBystander: null, oohcaDuration: 5 };
        
        // Populate duration selects
        (function() {
            var ihcaSelect = $('ihcaMinsWizard');
            for (var i = 1; i <= 60; i++) {
                var opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                ihcaSelect.appendChild(opt);
            }
            
            var oohcaSelect = $('oohcaMinsWizard');
            [5, 10, 15, 20, 30, 40, 47].forEach(function(m) {
                var opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                oohcaSelect.appendChild(opt);
            });
        })();
        
        function progShowStep(step) {
            document.querySelectorAll('#progWizard .wizard-step').forEach(function(s) {
                s.classList.remove('active');
            });
            var targetStep = document.querySelector('#progWizard .wizard-step[data-step="' + step + '"]');
            if (targetStep) targetStep.classList.add('active');
            
            // Update progress
            var dots = document.querySelectorAll('#progProgress .wizard-progress-dot');
            var stepNum = 1;
            if (step === 1) stepNum = 1;
            else if (step.indexOf('-2') > -1) stepNum = 2;
            else if (step.indexOf('-3') > -1) stepNum = 3;
            else if (step.indexOf('-4') > -1) stepNum = 4;
            else if (step.indexOf('-5') > -1) stepNum = 5;
            else if (step.indexOf('-result') > -1) stepNum = 5;
            
            dots.forEach(function(dot, i) {
                dot.classList.remove('complete', 'current');
                if (i < stepNum - 1) dot.classList.add('complete');
                if (i === stepNum - 1) dot.classList.add('current');
            });
        }
        
        // Type selection
        document.querySelectorAll('#progWizard .wizard-option[data-type]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var type = btn.getAttribute('data-type');
                progWizardData.type = type;
                progShowStep(type + '-2');
            });
        });
        
        // IHCA/OOHCA option clicks
        document.querySelectorAll('#progWizard .wizard-option[data-field]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var field = btn.getAttribute('data-field');
                var value = btn.getAttribute('data-value');
                progWizardData[field] = value;
                
                var currentStep = btn.closest('.wizard-step').getAttribute('data-step');
                var parts = currentStep.split('-');
                var type = parts[0];
                var stepNum = parseInt(parts[1], 10);
                var nextStep = type + '-' + (stepNum + 1);
                progShowStep(nextStep);
            });
        });
        
        // Duration auto-sync
        $('ihcaAutoSyncWizard').addEventListener('change', function() {
            if (this.checked && resusStarted) {
                var mins = Math.floor(totalSeconds / 60);
                $('ihcaMinsWizard').value = Math.min(Math.max(mins, 1), 60);
            }
        });
        
        $('oohcaAutoSyncWizard').addEventListener('change', function() {
            if (this.checked && resusStarted) {
                var mins = Math.floor(totalSeconds / 60);
                var options = [5, 10, 15, 20, 30, 40, 47];
                var closest = options.reduce(function(prev, curr) {
                    return Math.abs(curr - mins) < Math.abs(prev - mins) ? curr : prev;
                });
                $('oohcaMinsWizard').value = closest;
            }
        });
        
        // IHCA result
        $('ihcaShowResult').addEventListener('click', function() {
            progWizardData.duration = parseInt($('ihcaMinsWizard').value, 10);
            calculateIHCAResult();
            progShowStep('ihca-result');
        });
        
        function calculateIHCAResult() {
            var ageKey = progWizardData.age;
            var phenKey = progWizardData.witnessed + '-' + progWizardData.rhythm;
            var mins = progWizardData.duration;
            
            // Find closest timepoint
            var timepoints = [1, 10, 20, 30, 40, 50, 60];
            var closest = timepoints.reduce(function(prev, curr) {
                return Math.abs(curr - mins) < Math.abs(prev - mins) ? curr : prev;
            });
            
            var survData = survivalData[ageKey] && survivalData[ageKey][phenKey] ? survivalData[ageKey][phenKey][closest] : null;
            var neuroData = favorableOutcomeData[ageKey] && favorableOutcomeData[ageKey][phenKey] ? favorableOutcomeData[ageKey][phenKey][closest] : null;
            
            var survEl = $('ihcaSurvivalWizard');
            var neuroEl = $('ihcaNeuroWizard');
            
            survEl.classList.remove('good', 'medium', 'bad');
            neuroEl.classList.remove('good', 'medium', 'bad');
            
            if (survData) {
                survEl.textContent = survData;
                survEl.classList.add(getRangeClass(survData));
            } else {
                survEl.textContent = '';
            }
            
            if (neuroData) {
                neuroEl.textContent = neuroData;
                neuroEl.classList.add(getRangeClass(neuroData));
            } else {
                neuroEl.textContent = '';
            }
            
            function getRangeClass(rangeStr) {
                if (rangeStr === '<1%' || rangeStr === '<2%') return 'bad';
                if (rangeStr === '2-5%' || rangeStr === '5-10%') return 'medium';
                return 'good';
            }
        }
        
        // OOHCA result
        $('oohcaShowResult').addEventListener('click', function() {
            progWizardData.oohcaDuration = parseInt($('oohcaMinsWizard').value, 10);
            calculateOOHCAResult();
            progShowStep('oohca-result');
        });
        
        function calculateOOHCAResult() {
            var phenKey = progWizardData.oohcaRhythm + '_' + progWizardData.oohcaWitnessed + '_' + progWizardData.oohcaBystander;
            var mins = progWizardData.oohcaDuration;
            
            var resultEl = $('oohcaResultWizard');
            var noteEl = $('oohcaResultNote');
            resultEl.classList.remove('good', 'medium', 'bad');
            
            if (mins > 47) {
                resultEl.textContent = 'No survivors';
                resultEl.classList.add('bad');
                noteEl.textContent = 'Beyond 47 min of CPR in ROC-PRIMED study';
                return;
            }
            
            var data = oohcaPrognosis[phenKey];
            if (!data) {
                resultEl.textContent = '';
                noteEl.textContent = '';
                return;
            }
            
            // Find closest timepoint
            var timepoints = [5, 10, 15, 20, 30, 40];
            var closest = timepoints.reduce(function(prev, curr) {
                return Math.abs(curr - mins) < Math.abs(prev - mins) ? curr : prev;
            });
            
            var prob = data[closest];
            resultEl.textContent = prob;
            noteEl.textContent = 'If CPR ongoing at ' + closest + ' min';
            
            if (prob.includes('>30') || prob.includes('20-30')) {
                resultEl.classList.add('good');
            } else if (prob.includes('<1') || prob.includes('<2') || prob.includes('1-2')) {
                resultEl.classList.add('bad');
            } else {
                resultEl.classList.add('medium');
            }
        }
        
        function progBack(fromStep) {
            if (fromStep === 'ihca-2' || fromStep === 'oohca-2') {
                progShowStep(1);
            } else if (fromStep === 'ihca-result') {
                progShowStep('ihca-5');
            } else if (fromStep === 'oohca-result') {
                progShowStep('oohca-5');
            } else {
                var parts = fromStep.split('-');
                var type = parts[0];
                var stepNum = parseInt(parts[1], 10);
                progShowStep(type + '-' + (stepNum - 1));
            }
        }
        window.progBack = progBack;
        
        function progReset() {
            progWizardData = { type: null, age: null, witnessed: null, rhythm: null, duration: 1, oohcaRhythm: null, oohcaWitnessed: null, oohcaBystander: null, oohcaDuration: 5 };
            $('ihcaMinsWizard').value = '1';
            $('oohcaMinsWizard').value = '5';
            $('ihcaAutoSyncWizard').checked = false;
            $('oohcaAutoSyncWizard').checked = false;
            document.querySelectorAll('#progWizard .wizard-option').forEach(function(o) { o.classList.remove('selected'); });
            progShowStep(1);
        }
        window.progReset = progReset;
        
        // Log
        function renderLog() {
            if (log.length === 0) {
                $('logEntries').innerHTML = '<p class="log-empty">No events logged yet</p>';
            } else {
                $('logEntries').innerHTML = log.map(function(e) {
                    return '<div class="log-entry"><span class="time">' + e.time + '</span><span class="sep">  </span><span>' + e.event + '</span></div>';
                }).join('');
            }
        }
        
        $('btnCopyLog').addEventListener('click', function() {
            var text = log.map(function(e) { return e.time + ' - ' + e.event; }).join('\n');
            navigator.clipboard.writeText(text).then(function() { alert('Log copied to clipboard'); });
        });
        
        $('btnCopySummary').addEventListener('click', function() {
            var text = $('logSummaryContent').textContent;
            navigator.clipboard.writeText(text).then(function() { alert('Summary copied to clipboard'); });
        });
        
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') requestWakeLock();
        });
        
        // Service Worker for offline support
        if ('serviceWorker' in navigator) {
            var swCode = `
                var CACHE_NAME = 'codeClock-v47';
                self.addEventListener('install', function(e) {
                    e.waitUntil(
                        caches.open(CACHE_NAME).then(function(cache) {
                            return cache.addAll([location.href]);
                        })
                    );
                    self.skipWaiting();
                });
                self.addEventListener('fetch', function(e) {
                    e.respondWith(
                        caches.match(e.request).then(function(response) {
                            return response || fetch(e.request).then(function(fetchResponse) {
                                return caches.open(CACHE_NAME).then(function(cache) {
                                    cache.put(e.request, fetchResponse.clone());
                                    return fetchResponse;
                                });
                            });
                        }).catch(function() {
                            return caches.match(location.href);
                        })
                    );
                });
            `;
            var blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob), { scope: location.pathname })
                .catch(function() {});
        }
    })();
    </script>
</body>
</html>
